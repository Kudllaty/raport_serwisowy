<!DOCTYPE html>
<html lang="pl">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, maximum-scale=5.0, user-scalable=yes">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Dodanie jQuery i Select2 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- Dodanie ikon Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root {
      --cbs-green: #2ecc71;
      --dark-bg: #212529;
      --light-bg: #f8f9fa;
    }
    
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: var(--light-bg);
      padding: 0;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Dodana klasa dla wyrównania przycisków w grupie */
    .btn-group, .btn-group-vertical {
      position: relative;
      display: inline-flex;
      vertical-align: middle;
      align-items: center;
    }
    
    .container {
      max-width: 1200px;
      width: 100%;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin: 0 auto;
      flex-grow: 1;
    }
    
    /* Nagłówek i stopka */
    header, footer {
      background-color: var(--dark-bg);
      color: white;
      /*padding: 15px 0;*/
      width: 100%;
    }
    
    .header-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
    }
    
    .header-logo {
      height: 50px;
      margin-right: 10px;
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: bold;
      white-space: nowrap;
    }
    
    .highlight {
      color: var(--cbs-green);
    }
    
    .app-title {
      font-size: 20px;
      font-weight: 600;
    }
    
    footer {
      margin-top: auto;
      text-align: center;
    }
    
    .footer-container {
      justify-content: space-between;
      flex-wrap: wrap;
    }
    
    .footer-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .footer-contact {
      margin-top: 5px;
      font-size: 14px;
    }
    
    /* Banner główny - poprawiona wersja dla wszystkich urządzeń */
    .image-banner {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-bottom: 20px;
      width: 100%;
    }
    
    .banner-image {
      /**width: 24%;*/
      height: 180px;
      object-fit: cover;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 3px solid #e9ecef;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
    }
    
    .banner-image:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      border-color: #2ecc71;
    }
    
    /* Stylizacja panelu logowania */
    .login-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #f8f9fa; /* Jednolite tło zamiast obrazu */
      z-index: 2000; /* Wyższy z-index niż wszystkie inne elementy */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #loginSection {
      max-width: 450px;
      margin: 30px auto;
      /*text-align: center;*/
      background-color: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .login-logo {
      margin-bottom: 20px;
    }
    
    .login-title {
      font-size: 24px;
      font-weight: bold;
    }
    
    /* Istniejące style z poprawkami */
    .section {
      margin-bottom: 25px;
      padding: 15px;
      border: 1px solid #e9ecef;
      border-radius: 5px;
    }
    
    .section-title {
      font-size: 25px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #000000;
      border-bottom: 1px solid #e9ecef;
      padding-bottom: 10px;
      display: flex;
      align-items: center;
    }
    
    .section-title i {
      margin-right: 8px;
    }
    
    .btn-primary, .btn-success {
      margin: 5px 0;
    }
    
    .hidden {
      display: none;
    }
    
    .product-image {
      max-width: 80px;
      max-height: 80px;
      object-fit: contain;
      border: 3px solid #ddd;
      border-radius: 8px;
      padding: 5px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      transition: all 0.2s ease-in-out;
    }
    
    .product-image:hover {
      transform: scale(1.1);
      border-color: #2ecc71;
    }
    
    .product-detail-image {
      max-width: 200px;
      max-height: 200px;
      object-fit: contain;
      border: 4px solid #ddd;
      border-radius: 10px;
      padding: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }
    
    .product-detail-image:hover {
      transform: scale(1.05);
      border-color: #2ecc71;
    }
    
    .order-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .order-table th, .order-table td {
      padding: 8px;
      border: 1px solid #e9ecef;
      text-align: center;
      vertical-align: middle;
    }
    
    .order-table th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    
    .product-item {
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .product-item:hover {
      background-color: #f0f8ff;
      transform: translateY(-2px);
    }
    
    .loader {
      border: 5px solid #f3f3f3;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      margin: 20px auto;
      position: relative;
      animation: rotate 1.5s linear infinite;
    }

    .loader:before, .loader:after {
      content: "";
      position: absolute;
      top: -5px;
      left: -5px;
      right: -5px;
      bottom: -5px;
      border-radius: 50%;
      border: 5px solid transparent;
      border-top-color: #0d6efd;
      border-bottom-color: #0d6efd;
      animation: rotate-reverse 1s linear infinite;
    }

    .loader:after {
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-top-color: transparent;
      border-bottom-color: transparent;
      border-left-color: #0d6efd;
      border-right-color: #0d6efd;
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes rotate-reverse {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(-360deg); }
    }
    
    #user-info {
      text-align: right;
      /*margin-bottom: 20px;*/
    }
    
    #searchResults {
      max-height: 400px;
      overflow-y: auto;
    }
    
    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }
      
      .container {
        padding: 10px;
        width: 100%;
        max-width: 100%;
        margin: 0;
      }
      
      .section {
        padding: 10px;
      }
      
      .product-image {
        max-width: 50px;
        max-height: 50px;
      }
      
      .header-container, .footer-container {
        flex-direction: column;
        text-align: center;
        padding: 10px;
      }
      
      .app-title {
        margin-left: 0;
        margin-top: 10px;
      }
      
      .logo-container {
        justify-content: center;
      }
      
      .footer-content, .footer-logo {
        margin-bottom: 10px;
        align-items: center;
      }
      
      /* Dostosowanie tabeli do ekranów mobilnych */
      .order-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
        width: 100%;
        font-size: 12px;
      }
      
      /* Dostosowanie przycisków i formularzy */
      .btn-group {
        flex-wrap: wrap;
        width: 100%;
        align-items: center;
        justify-content: center;
      }
      
      .btn-group .btn {
        flex: 1 0 auto;
        margin-bottom: 5px;
        padding: 6px;
        font-size: 12px;
      }
      
      .section-title {
        font-size: 16px;
      }
      
      .form-control, .form-select, .btn {
        font-size: 14px;
      }
      
      .btn {
        padding: 8px 12px;
        margin: 2px;
      }
      
      #addressDetails .card {
        margin-top: 10px;
      }
      
      .image-banner {
        flex-wrap: wrap;
        justify-content: space-evenly;
      }
      
      .banner-image {
        width: 48%;
        height: 120px;
        margin: 0 0 8px 0;
      }
      
      .select2-container .select2-selection--single {
        height: 38px !important;
      }
      
      .modal-dialog {
        margin: 10px;
      }
      
      .mechanic-animation img {
        max-width: 100%;
      }

      #notification-container {
        width: 90%;
        right: 5%;
        left: 5%;
      }

      .select2-dropdown {
        width: 88% !important;
        max-width: 88% !important;
        position: absolute !important;
        left: 0 !important;
        right: 0 !important;
        margin: 0 auto !important;
        transform: translateY(0) !important;
        z-index: 10000;
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      }
      
      /* Specjalne ustawienie dla section pierwszego typu (Dane podstawowe) */
      .section:first-of-type .select2-container .select2-dropdown {
        top: 38px !important;
        position: absolute !important;
        margin-top: 0 !important;
      }
      
      /* Zwiększona wysokość guzików i opcji dla lepszego dotyku */
      .select2-container--default .select2-results__option {
        padding: 10px;
        font-size: 16px;
      }
      
      /* Specjalne ustawienie dla section pierwszego typu (Dane podstawowe) */
      .section:first-of-type .select2-container .select2-dropdown {
        top: 100% !important;
        position: absolute !important;
        margin-top: 0 !important;
      }
      
      /* Poprawione pozycjonowanie pola wyszukiwania w dropdown */
      .select2-search--dropdown {
        padding: 6px !important;
        width: 100% !important;
        box-sizing: border-box !important;
      }
      
      .select2-search__field {
        width: 100% !important;
        padding: 8px !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        border-radius: 4px !important;
        font-size: 16px !important; /* Zapobiega powiększaniu przez iOS */
      }
      
      /* Zwiększona wysokość guzików i opcji dla lepszego dotyku */
      .select2-container--default .select2-results__option {
        padding: 10px;
        font-size: 16px;
      }
      
      /* Ustawienie szerokości pola wyszukiwania na taką samą jak dropdown */
      .select2-search--dropdown .select2-search__field {
        width: 100% !important;
        margin: 5px auto;
        display: block;
      }

      /* Dodanie przycisku zamknięcia do dropdown */
      .select2-mobile-close-btn {
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        background: #f8f9fa;
        padding: 8px;
        text-align: right;
        border-bottom: 1px solid #ddd;
        z-index: 10;
      }
      
      .select2-mobile-close-btn button {
        background: #dc3545;
        color: white;
        border: none;
        padding: 4px 10px;
        border-radius: 4px;
      }
    }
    
    /* Poprawka dla modalu produktów - zwiększona wysokość */
    .modal-xl .modal-body {
      max-height: 80vh;
      overflow-y: auto;
    }
    
    #productSearchResults {
      max-height: 70vh;
      overflow-y: auto;
    }

    /* Animacja sukcesu */
    .success-animation {
      display: inline-block;
    }
    
    .animated-checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: block;
      stroke-width: 3;
      stroke: #28a745;
      stroke-miterlimit: 10;
      box-shadow: inset 0px 0px 0px #28a745;
      animation: fill-checkmark 0.4s ease-in-out 0.4s forwards, scale-checkmark 0.3s ease-in-out 0.9s both;
    }
    
    .animated-checkmark-circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 3;
      stroke-miterlimit: 10;
      stroke: #28a745;
      fill: none;
      animation: stroke-checkmark 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    
    .animated-checkmark-check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke-checkmark 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }
    
    @keyframes stroke-checkmark {
      100% {
        stroke-dashoffset: 0;
      }
    }
    
    @keyframes fill-checkmark {
      100% {
        box-shadow: inset 0px 0px 0px 30px #28a745;
      }
    }
    
    @keyframes scale-checkmark {
      0%, 100% {
        transform: none;
      }
      50% {
        transform: scale3d(1.1, 1.1, 1);
      }
    }

    /* Success checkmark animation */
    .success-animation {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 0 auto;
    }

    .animated-checkmark {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: block;
      stroke-width: 2;
      stroke: #4BB543;
      stroke-miterlimit: 10;
      box-shadow: inset 0px 0px 0px #4BB543;
      animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
      position: relative;
      top: 5px;
      right: 5px;
      margin: 0 auto;
    }

    .animated-checkmark-circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 2;
      stroke-miterlimit: 10;
      stroke: #4BB543;
      fill: none;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }

    .animated-checkmark-check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }

    @keyframes stroke {
      100% {
        stroke-dashoffset: 0;
      }
    }

    @keyframes scale {
      0%, 100% {
        transform: none;
      }
      50% {
        transform: scale3d(1.1, 1.1, 1);
      }
    }

    @keyframes fill {
      100% {
        box-shadow: inset 0px 0px 0px 30px #4BB543;
      }
    }

    /* Style dla Select2 */
    .select2-container {
      width: 100% !important;
      max-width: 100%;
    }
    
    .select2-container--default .select2-selection--single {
      height: 38px;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 36px;
      padding-left: 12px;
      white-space: normal; /* Pozwoli na zawijanie długich tekstów */
      word-break: break-word; /* Pomoże z długimi słowami */
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 36px;
    }
    
    .select2-container .select2-dropdown {
      position: absolute !important;
      left: 0 !important; /* Wyrównanie do lewej krawędzi */
    }
    
    .select2-dropdown {
      left: 0 !important; /* Wyrównanie do lewej krawędzi */
      margin-left: 0 !important; /* Zapewnienie braku przesunięć */
      transform: none !important; /* Wyłączenie wszelkich transformacji */
    }
    
    /* Poprawione dostosowanie Select2 dla mobile */
    @media (max-width: 768px) {
      .select2-dropdown {
        width: 88% !important;
        max-width: 88% !important;
        position: absolute !important;
        left: 0 !important;
        right: 0 !important;
        /*margin: 0 auto !important;*/
        transform: translateY(0) !important;
        z-index: 10000;
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      }
      
      /* Specjalne ustawienie dla section pierwszego typu (Dane podstawowe) */
      .section:first-of-type .select2-container .select2-dropdown {
        top: 38px !important;
        position: absolute !important;
        margin-top: 0 !important;
      }
      
      /* Poprawione pozycjonowanie pola wyszukiwania w dropdown */
      .select2-search--dropdown {
        padding: 6px !important;
        width: 100% !important;
        box-sizing: border-box !important;
      }
      
      .select2-search__field {
        width: 100% !important;
        padding: 8px !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        border-radius: 4px !important;
        font-size: 16px !important; /* Zapobiega powiększaniu przez iOS */
      }
      
      /* Zwiększona wysokość guzików i opcji dla lepszego dotyku */
      .select2-container--default .select2-results__option {
        padding: 10px;
        font-size: 16px;
      }
      
      /* Specjalne ustawienie dla section pierwszego typu (Dane podstawowe) */
      .section:first-of-type .select2-container .select2-dropdown {
        top: 100% !important;
        position: absolute !important;
        margin-top: 0 !important;
      }
      
      /* Zwiększona wysokość guzików i opcji dla lepszego dotyku */
      .select2-container--default .select2-results__option {
        padding: 10px;
        font-size: 16px;
      }
      
      /* Ustawienie szerokości pola wyszukiwania na taką samą jak dropdown */
      .select2-search--dropdown .select2-search__field {
        width: 100% !important;
        margin: 5px auto;
        display: block;
      }

      /* Dodanie przycisku zamknięcia do dropdown */
      .select2-mobile-close-btn {
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        background: #f8f9fa;
        padding: 8px;
        text-align: right;
        border-bottom: 1px solid #ddd;
        z-index: 10;
      }
      
      .select2-mobile-close-btn button {
        background: #dc3545;
        color: white;
        border: none;
        padding: 4px 10px;
        border-radius: 4px;
      }
    }
    
    /* Style dla niestandardowych powiadomień */
    /* Animacja mechanika - poprawiony styl */
    .mechanic-animation {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      margin: 20px auto;
      text-align: center;
    }
    
    .mechanic-animation img {
      max-width: 400px;
      max-height: 400px;
    }

    /* Style dla systemu powiadomień - pełniejsza implementacja */
    #notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      width: 350px;
    }
    
    .toast-notification {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      margin-bottom: 15px;
      overflow: hidden;
      opacity: 1;
      animation: fade-in 0.3s ease-in;
    }
    
    .toast-notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .toast-notification-title {
      margin: 0;
      font-size: 18px;
      font-weight: 500;
    }
    
    .toast-notification-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 0 5px;
    }
    
    .toast-notification-body {
      padding: 15px;
      margin: 0;
    }
    
    .toast-success {
      border-left: 5px solid #2ecc71;
    }
    
    .toast-error {
      border-left: 5px solid #dc3545;
    }
    
    .toast-warning {
      border-left: 5px solid #ffc107;
    }
    
    .toast-info {
      border-left: 5px solid #17a2b8;
    }
    
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fade-out {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }

    /* Style dla kafelków typu serwisu */
    .service-type-card label {
      cursor: pointer;
      width: 100%;
      height: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      border: 2px solid #dee2e6 !important;
      text-align: center;
      padding: 20px;
    }
    
    .service-type-card label:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-color: #0d6efd !important;
    }
    
    .service-type-card input[type="radio"] {
      position: absolute;
      opacity: 0;
    }
    
    .service-type-card input[type="radio"]:checked + label {
      background-color: #e7f1ff;
      border-color: #0d6efd !important;
      box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3);
    }

    .service-type-icon {
      font-size: 2.5rem;
      margin-bottom: 15px;
      color: #0d6efd;
    }
    
    .service-type-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .service-type-description {
      font-size: 0.9rem;
      color: #6c757d;
    }
      .selected-service-type {
      background-color: #e7f1ff;
      border-color: #0d6efd !important;
      box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3);
    }

    /* Style dla zablokowanych przycisków typu serwisu */
    .service-type-card.disabled label {
      pointer-events: none;
      opacity: 0.6;
      cursor: not-allowed;
      background-color: #f8f9fa !important;
      color: #6c757d !important;
      border-color: #dee2e6 !important;
      box-shadow: none !important;
    }

    .service-type-card.disabled label:hover {
      transform: none !important;
      box-shadow: none !important;
      border-color: #dee2e6 !important;
    }

    .service-type-card.disabled input[type="radio"] {
      pointer-events: none;
    }

    /* Wskaźnik ładowania w sekcji rodzaj serwisu */
    .service-type-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      display: none;
    }

    .service-type-card {
      position: relative;
    }

    /* Style dla kafelków kategorii produktów */
    .category-tile {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 4px 12px;
      margin-bottom: 5px;
      margin-right: 3px;
      cursor: pointer;
      transition: all 0.3s;
      background-color: #f8f9fa;
      color: #333;
    }

    .category-tile:hover {
      box-shadow: 0 0 8px rgba(13, 110, 253, 0.3);
      border-color: #0d6efd;
    }

    .category-tile.category-tile-active {
      background-color: #198754 !important;
      color: #fff !important;
      border-color: #198754 !important;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(25,135,84,0.15);
    }

    /* Styl dla ikon kategorii */
    .category-icon {
      font-size: 1.0rem;  /* Zmniejszony rozmiar ikon */
      margin-bottom: 3px;
    }

    /* Dodatkowy margin dla układu kategorii w modalu */
    #categoryTilesContainerModal .category-tile {
      margin: 3px;
    }

    /* Style dla pól wymaganych */
    .required-field::after {
      content: " *";
      color: #dc3545;
      font-weight: bold;
    }

    /* Dodatkowe style dla panelu zdjęć */
    .image-upload-area {
      border: 2px dashed #ccc;
      border-radius: 5px;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 20px;
      background-color: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .image-upload-area:hover {
      border-color: #0d6efd;
      background-color: #f0f7ff;
    }

    .image-upload-area.drag-over {
      border-color: #198754;
      background-color: #e8f4ea;
    }

    .image-upload-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #6c757d;
    }

    .image-upload-placeholder i {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #0d6efd;
    }

    .image-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      background-color: #f8f9fa;
    }

    .image-preview-item {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 5px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-preview-item .remove-image {
      position: absolute;
      top: 3px;
      right: 3px;
      background-color: rgba(255,255,255,0.7);
      color: #dc3545;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
    }

    .image-preview-item .image-type {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 2px 5px;
      background-color: rgba(0,0,0,0.5);
      color: white;
      font-size: 10px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
  <title>Panel Raportów Serwisowych</title>
</head>

<body>
  <!-- Ekran logowania (całostronicowy z tłem) -->
  <div class="login-wrapper hidden" id="loginWrapper">
    <div id="loginSection" style="width: 400px; max-width: 400px;">
      <div class="section">
        <div class="section-title"><i class="bi bi-tools" style="color: orange;"></i>Raport serwisowy</div>
        <div class="mb-3">
          <label for="login" class="form-label"><i class="bi bi-person"></i> Login:</label>
          <input type="text" class="form-control" id="login" placeholder="Wprowadź login">
        </div>
        <div class="mb-3">
          <label for="password" class="form-label"><i class="bi bi-key"></i> Hasło:</label>
          <input type="password" class="form-control" id="password" placeholder="Wprowadź hasło">
        </div>
        <div class="mb-3">
          <button class="btn btn-primary w-100" onclick="handleLogin()" style="background: linear-gradient(to right, #e74c3c, #f39c12); border: none;"><i class="bi bi-box-arrow-in-right"></i> Zaloguj się</button>
        </div>
        <div id="loginError" class="alert alert-danger hidden"></div>
      </div>
    </div>
  </div>

  <!-- Główna zawartość aplikacji -->
  <div id="appContent" class="hidden">
    <!-- Nagłówek -->
    <header>
      <div class="header-container">
        <div class="logo-container">
          <img id="headerLogoImg" class="header-logo" alt="Logo CBS">
          <div class="logo-text">CARGO <span class="highlight">BIKE</span> SERWIS</div>
        </div>        <div id="user-info" class="d-flex align-items-center">
          <span id="user-name" class="me-2"><i class="bi bi-person-circle"></i> </span>
          <button id="emailConfigBtn" class="btn btn-sm btn-outline-primary me-2 hidden" onclick="showEmailConfigModal()">
            <i class="bi bi-envelope-gear"></i> Konfiguracja Email
          </button>
          <button class="btn btn-sm btn-danger" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Wyloguj</button>
        </div>
      </div>
    </header>

    <div class="container" id="mainContainer">
      <!-- Baner ze zdjęciami pod nagłówkiem -->
      <div class="image-banner">
        <img id="bannerImage1" class="banner-image" alt="Zdjęcie 1">
        <img id="bannerImage2" class="banner-image" alt="Zdjęcie 2">
        <img id="bannerImage3" class="banner-image" alt="Zdjęcie 3">
        <img id="bannerImage4" class="banner-image" alt="Zdjęcie 4">
      </div>
      
      <!-- Panel główny -->
      <div id="appPanel"></div>
        <!-- Panel zamówieniowy przeniesiony z nagłówka -->
        <div class="app-title text-center mb-4">PANEL RAPORTÓW SERWISOWYCH</div>

        <!-- Sekcja 1: Dane podstawowe -->
        <div class="section">
          <div class="section-title"><i class="bi bi-clipboard-data"></i> 1. Dane podstawowe</div>
          <div class="row">
            <div class="col-md-3 mb-3">
              <label for="service" class="form-label required-field"><i class="bi bi-building"></i> Rodzaj serwisu:</label>
              <select class="form-select" id="service" onchange="handleServiceChange()">
                <option value="">Wybierz serwis</option>
              </select>
            </div>
            <div class="col-md-3 mb-3">
              <label for="repairCategory" class="form-label"><i class="bi bi-tags"></i> Kategoria naprawy:</label>
              <select class="form-select" id="repairCategory" disabled onchange="handleCategoryChange()">
                <option value="">Wybierz kategorię</option>
              </select>
            </div>
            <div class="col-md-3 mb-3">
              <label for="operator" class="form-label"><i class="bi bi-person"></i> Operator:</label>
              <select class="form-select" id="operator" disabled onchange="handleOperatorChange()">
                <option value="">Wybierz operatora</option>
              </select>
            </div>
            <div class="col-md-3 mb-3">
              <label for="department" class="form-label"><i class="bi bi-diagram-3"></i> Oddział:</label>
              <select class="form-select" id="department" disabled onchange="handleDepartmentChange()">
                <option value="">Wybierz oddział</option>
              </select>
            </div>
          </div>
        </div>        <!-- Sekcja 2: Szczegóły naprawy (uproszczona) -->
        <div class="section">
          <div class="section-title"><i class="bi bi-gear-fill"></i> 2. Szczegóły naprawy</div>
          <div class="row mb-3">
            <div class="col-md-6 mb-3">
              <label for="serviceDate" class="form-label required-field"><i class="bi bi-calendar-check"></i> Data serwisu:</label>
              <input type="date" class="form-control" id="serviceDate">
            </div>
            <div class="col-md-6 mb-3">
              <label for="bikeMileage" class="form-label required-field"><i class="bi bi-speedometer"></i> Przebieg (km):</label>
              <input type="number" class="form-control" id="bikeMileage" placeholder="Wprowadź przebieg roweru" min="0">
            </div>
          </div>
  
          
          <div class="row mb-3">
            <div class="col-md-6 mb-3">
              <label for="frameNumberSelect" class="form-label required-field"><i class="bi bi-upc-scan"></i> Numer ramy:</label>
              <select class="form-select" id="frameNumberSelect">
                <option value="">Wybierz numer ramy</option>
              </select>
              <small class="form-text text-muted">Lista ram powiązana z wybranym oddziałem (przykład: AP916)</small>
            </div>
            <div class="col-md-6 mb-3">
              <label for="lastInspection" class="form-label"><i class="bi bi-calendar-check"></i> Ostatni przegląd:</label>
              <input type="date" class="form-control" id="lastInspection" disabled>
            </div>
          </div>
        </div>

        <!-- Sekcja 3: Rodzaj serwisu (jako kafelki) -->
        <div class="section">
          <div class="section-title"><i class="bi bi-wrench"></i> 3. Rodzaj serwisu</div>
          
          <!-- Wskaźnik ładowania danych -->
          <div id="serviceTypeLoadingIndicator" class="text-center py-3 d-none">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Ładowanie...</span>
            </div>
            <p class="mt-2 text-muted">Ładowanie wymaganych danych...</p>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6 mb-3">
              <div class="service-type-card" id="serviceTypeBasicCard">
                <input type="radio" name="serviceType" id="serviceTypeBasic" value="Podstawowy">
                <label for="serviceTypeBasic" class="card h-100" onclick="selectServiceType('Podstawowy')">
                  <div class="service-type-icon"><i class="bi bi-tools"></i></div>
                  <div class="service-type-title">Serwis Podstawowy</div>
                  <div class="service-type-description">
                  
                  </div>
                </label>
                <div class="service-type-loading">
                  <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Ładowanie...</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="service-type-card" id="serviceTypeAdvancedCard">
                <input type="radio" name="serviceType" id="serviceTypeAdvanced" value="Eksploatacyjny">
                <label for="serviceTypeAdvanced" class="card h-100" onclick="selectServiceType('Eksploatacyjny')">
                  <div class="service-type-icon"><i class="bi bi-gear-fill"></i></div>
                  <div class="service-type-title">Serwis Eksploatacyjny</div>
                  <div class="service-type-description">
                    
                  </div>
                </label>
                <div class="service-type-loading">
                  <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Ładowanie...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
            <hr class="my-4">
          
        <!-- Sekcja 4: Opcje Serwisowe -->
        <div class="section">
          <div class="section-title"><i class="bi bi-gear"></i> Opcje Serwisowe</div>
          <div class="row mb-3">
            <div class="col-md-6 mb-3">
              <label for="isOnSite" class="form-label">Dojazd</label>
              <select class="form-select" id="isOnSite" name="isOnSite">
                <option value="">Wybierz opcję</option>
                <option value="tak">Tak</option>
                <option value="nie">Nie</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="laborHours" class="form-label">Roboczo-godziny</label>
              <input type="number" class="form-control" id="laborHours" name="laborHours" min="0" step="0.5" placeholder="Wprowadź liczbę godzin">
            </div>
          </div>
        </div>
          
        <hr class="my-4">
          
        <!-- Sekcja: Usługi podczas naprawy -->
        <div class="section">
          <div class="section-title"><i class="bi bi-tools"></i> Usługi podczas naprawy</div>
          <div class="row mb-3">
            <div class="col-12">
              <div class="d-flex justify-content-between mb-3">
                <button class="btn btn-primary" id="openServiceSearchBtn" onclick="openServiceSearchModal()">
                  <i class="bi bi-search"></i> Wyszukaj usługi
                </button>
              </div>
            </div>
          </div>
          
          <div class="order-summary mb-3">
            <div class="table-responsive">
              <table class="table table-hover service-table">
                <thead>
                  <tr class="table-primary">
                    <th>Kod</th>
                    <th>Nazwa usługi</th>
                    <th>Kategoria</th>
                    <th>Cena</th>
                    <th>Akcje</th>
                  </tr>
                </thead>
                <tbody id="serviceItems">
                  <tr id="noServiceItemsRow">
                    <td colspan="5" class="text-center">Brak dodanych usług</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="table-info">
                    <td colspan="2" class="text-end fw-bold">Suma:</td>
                    <td class="fw-bold" id="serviceTotalQuantity">0</td>
                    <td class="fw-bold" id="serviceTotal">0.00 zł</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
          
        <!-- Części użyte do naprawy -->
        <div class="section">
          <div class="section-title"><i class="bi bi-gear"></i> Części użyte do naprawy <small class="text-muted">(opcjonalne)</small></div>
          <div class="row mb-3">
            <div class="col-12">
              <div class="d-flex justify-content-between mb-3">
                <button class="btn btn-primary" id="openProductSearchBtn" onclick="openProductSearchModal()">
                  <i class="bi bi-search"></i> Wyszukaj części
                </button>
              </div>
            </div>
          </div>
          
          <div id="searchResultsContainer" class="mb-4 hidden">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> Wyniki wyszukiwania</h5>
                <button type="button" class="btn-close" aria-label="Close" onclick="closeSearchResults()"></button>
              </div>
              <div class="card-body">
                <div id="searchResults" class="row">
                  <!-- Tu będą wyniki wyszukiwania -->
                </div>
              </div>
            </div>          </div>
          <div class="order-summary mb-3">
            <div class="table-responsive">
              <table class="table table-hover order-table">
                <thead>
                  <tr class="table-primary">
                    <th>Kod</th>
                    <th>Nazwa części</th>
                    <th>Kategoria</th>
                    <th>Ilość</th>
                    <th>Zdjęcia</th>
                    <th>Akcje</th>
                  </tr>
                </thead>
                <tbody id="orderItems">
                  <tr id="noItemsRow">
                    <td colspan="6" class="text-center">Brak dodanych części</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="table-info">
                    <td colspan="3" class="text-end fw-bold">Suma:</td>
                    <td class="fw-bold" id="orderTotalQuantity">0</td>
                    <td colspan="2"></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>        <!-- Sekcja 5: Zdjęcia serwisowe - zaktualizowana wersja -->
        <div class="section">
          <div class="section-title"><i class="bi bi-camera"></i> 5. Zdjęcia serwisowe</div>
          
          <!-- Panele z zakładkami do wyboru typu zdjęć -->
          <ul class="nav nav-tabs" id="imagesTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="before-tab" data-bs-toggle="tab" data-bs-target="#before-images" type="button" role="tab" aria-controls="before-images" aria-selected="true">
                <i class="bi bi-image"></i> Zdjęcia przed naprawą (<span id="beforeImageCount">0</span>)
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="after-tab" data-bs-toggle="tab" data-bs-target="#after-images" type="button" role="tab" aria-controls="after-images" aria-selected="false">
                <i class="bi bi-image-fill"></i> Zdjęcia po naprawie (<span id="afterImageCount">0</span>)
              </button>
            </li>
          </ul>
          
          <div class="tab-content p-3 border border-top-0 rounded-bottom mb-3" id="imagesTabContent">
            <!-- Panel zdjęć przed naprawą -->
            <div class="tab-pane fade show active" id="before-images" role="tabpanel" aria-labelledby="before-tab">
              <input type="hidden" id="beforeImagesLink" value="">
              <div class="image-upload-area" id="beforeImageUpload" onclick="document.getElementById('beforeImagesInput').click()">
                <div class="image-upload-placeholder">
                  <i class="bi bi-cloud-arrow-up"></i>
                  <div>Kliknij lub upuść zdjęcia tutaj</div>
                  <div class="text-muted small">Możesz wybrać wiele zdjęć naraz</div>
                </div>
                <input type="file" id="beforeImagesInput" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event, 'before')">
              </div>
              <div id="beforeImagesPreview" class="image-preview-container" style="display: none;"></div>
            </div>
            
            <!-- Panel zdjęć po naprawie -->
            <div class="tab-pane fade" id="after-images" role="tabpanel" aria-labelledby="after-tab">
              <input type="hidden" id="afterImagesLink" value="">
              <div class="image-upload-area" id="afterImageUpload" onclick="document.getElementById('afterImagesInput').click()">
                <div class="image-upload-placeholder">
                  <i class="bi bi-cloud-arrow-up"></i>
                  <div>Kliknij lub upuść zdjęcia tutaj</div>
                  <div class="text-muted small">Możesz wybrać wiele zdjęć naraz</div>
                </div>
                <input type="file" id="afterImagesInput" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event, 'after')">
              </div>
              <div id="afterImagesPreview" class="image-preview-container" style="display: none;"></div>
            </div>
          </div>
        </div>        <!-- Sekcja 6: Uwagi do raportu -->
        <div class="section">
          <div class="section-title"><i class="bi bi-chat-left-text"></i> 6. Uwagi do raportu</div>
          <textarea class="form-control" id="orderNotes" rows="4" placeholder="Wprowadź dodatkowe uwagi do raportu serwisowego..."></textarea>
          
          <!-- Pole email dla potwierdzenia serwisu -->
          <div class="mt-3">
            <label for="serviceConfirmationEmail" class="form-label">
              <i class="bi bi-envelope"></i> Email do potwierdzenia serwisu <span class="text-danger">*</span>
            </label>
            <input type="email" class="form-control" id="serviceConfirmationEmail" 
                   placeholder="Wprowadź adres email na który zostanie wysłane potwierdzenie serwisu" required>
            <div class="invalid-feedback">
              Proszę wprowadzić prawidłowy adres email dla potwierdzenia serwisu.
            </div>
          </div>
        </div>

        <!-- Przycisk wysłania raportu -->
        <div class="text-center mb-4">
          <button class="btn btn-success btn-lg" id="submitOrderBtn" onclick="submitOrder()" disabled><i class="bi bi-send"></i> Zapisz raport</button>
        </div>
      </div>
      
      <!-- Animacja mechanika - nowe źródło GIF -->
      <div class="mechanic-animation">
        <img src="https://cdn.dribbble.com/users/1162077/screenshots/4649464/media/c6590c70a5966a3baf311f081cdda5ff.gif" alt="Animacja mechanika">
      </div>
    </div>

    <!-- Stopka -->
    <footer>
      <div class="footer-container">
        <div class="footer-content">
          <div>© 2024 CARGO <span class="highlight">BIKE</span> SERWIS Sp. z o.o.</div>
          <div class="footer-contact">
            Kontakt: 📞 +48 888 788 847 | ✉️ biuro@cargobikeserwis.com
          </div>
        </div>
      </div>
    </footer>
  </div>

  <!-- Modal szczegółów produktu -->
  <div class="modal fade" id="productDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productDetailTitle"><i class="bi bi-box"></i> Szczegóły produktu</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-5 text-center mb-3">
              <img id="productDetailImage" class="product-detail-image img-fluid" src="" alt="Zdjęcie produktu">
            </div>
            <div class="col-md-7">
              <h5 id="productDetailName"></h5>
              <p id="productDetailCode" class="text-muted"></p>
              <p id="productDetailCategory"></p>
              <div class="mb-3">
                <label for="productQuantity" class="form-label"><i class="bi bi-123"></i> Ilość:</label>
                <input type="number" class="form-control" id="productQuantity" min="1" value="1">
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle"></i> Anuluj</button>
          <button type="button" class="btn btn-primary" id="addToOrderBtn"><i class="bi bi-cart-plus"></i> Dodaj do zamówienia</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal wyszukiwania produktów -->
  <div class="modal fade" id="productSearchModal" tabindex="-1" aria-modal="true" aria-labelledby="productSearchModalTitle">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productSearchModalTitle"><i class="bi bi-search"></i> Wyszukiwanie produktów</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col">
              <div class="input-group">
                <input type="text" class="form-control" id="productSearchInput" placeholder="Wprowadź nazwę lub kod produktu...">
                <button class="btn btn-primary" id="searchProductBtn" type="button">
                  <i class="bi bi-search"></i> Szukaj
                </button>
              </div>
            </div>
          </div>
          <!-- Kontener na kafelki kategorii produktów - widoczny -->
          <div id="categoryTilesContainer" class="mb-3">
            <div class="d-none">
              Kategoria naprawy: <span class="text-success">Cargo</span>
            </div>
            <div class="d-none">
              Kategoria produktu: <span class="text-primary" style="word-break: break-word;">Drivetrain</span>
            </div>
            <div class="d-flex flex-wrap gap-2" id="categoryTilesWrapper">
              <!-- Tu będą dynamicznie wstawione kafelki kategorii -->
            </div>
          </div>
          <div id="productSearchLoading" class="text-center py-3 d-none">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Ładowanie...</span>
            </div>
            <p>Trwa ładowanie wszystkich produktów...</p>
          </div>
          <div id="productSearchNoResults" class="alert alert-info d-none">
            Nie znaleziono produktów pasujących do wyszukiwania.
          </div>
          <div id="productSearchResults" class="row mt-3">
            <!-- Tu będą wyniki wyszukiwania -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal wyszukiwania usług -->
  <div class="modal fade" id="serviceSearchModal" tabindex="-1" aria-modal="true" aria-labelledby="serviceSearchModalTitle">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="serviceSearchModalTitle"><i class="bi bi-search"></i> Wyszukiwanie usług</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" id="serviceSearchInput" placeholder="Filtruj spośród usług...">
              </div>
              <div class="form-text">Wszystkie usługi są automatycznie ładowane dla wybranej kategorii. Możesz filtrować usługi wpisując tekst powyżej.</div>
            </div>
          </div>
          <div id="serviceSearchLoading" class="text-center py-3 d-none">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Wyszukiwanie...</span>
            </div>
            <p>Trwa ładowanie wszystkich usług...</p>
          </div>
          <div id="serviceSearchNoResults" class="alert alert-info d-none">
            Nie znaleziono usług pasujących do wyszukiwania.
          </div>
          <div id="serviceSearchResults" class="row mt-3">
            <!-- Tu będą wyniki wyszukiwania -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal szczegółów usługi -->
  <div class="modal fade" id="serviceDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="serviceDetailTitle"><i class="bi bi-tools"></i> Szczegóły usługi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-12">
              <h5 id="serviceDetailName"></h5>
              <p id="serviceDetailCode" class="text-muted"></p>
              <p id="serviceDetailCategory"></p>
              <div class="mb-3">
                <label for="servicePrice" class="form-label"><i class="bi bi-currency-dollar"></i> Cena jednostkowa:</label>
                <input type="number" class="form-control" id="servicePrice" min="0" step="0.01" value="0.00">
                <small class="form-text text-muted" id="servicePriceInfo">Możesz edytować cenę usługi.</small>
              </div>
              <input type="hidden" id="serviceQuantity" value="1">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle"></i> Anuluj</button>
          <button type="button" class="btn btn-primary" id="addServiceToOrderBtn"><i class="bi bi-cart-plus"></i> Dodaj usługę</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal ładowania - naprawiona dostępność -->
  <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <div class="loader"></div>
          <p id="loadingMessage">Proszę czekać...</p>
        </div>
      </div>
    </div>  </div>

  <!-- Modal konfiguracji email -->
  <div class="modal fade" id="emailConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-envelope-gear"></i> Konfiguracja adresów email</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="emailConfigService" class="form-label">Serwis</label>
            <select class="form-select" id="emailConfigService" onchange="loadEmailConfigForService()">
              <option value="">Wybierz serwis...</option>
            </select>
          </div>
          
          <div id="emailConfigForm" class="d-none">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="serviceEmail" class="form-label">
                    <i class="bi bi-envelope"></i> Email serwisu
                  </label>
                  <input type="email" class="form-control" id="serviceEmail" 
                         placeholder="email@serwis.pl">
                  <div class="form-text">
                    Adres email do wysyłania potwierdzeń zamówień (bez cen)
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="supervisorEmail" class="form-label">
                    <i class="bi bi-person-badge"></i> Email opiekuna
                  </label>
                  <input type="email" class="form-control" id="supervisorEmail" 
                         placeholder="opiekun@firma.pl">
                  <div class="form-text">
                    Adres email opiekuna (z pełnymi danymi i cenami)
                  </div>
                </div>
              </div>
            </div>
            
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i>
              <strong>Hierarchia adresów email:</strong>
              <ol class="mb-0 mt-2">
                <li>Konfiguracja email (ta strona) - <strong>najwyższy priorytet</strong></li>
                <li>Arkusz "Użytkownicy" - jeśli brak konfiguracji</li>
                <li>Arkusz "Adresy" - jako ostatnia opcja</li>
              </ol>
            </div>
          </div>
          
          <div id="allEmailConfigs" class="mt-4">
            <h6>Wszystkie konfiguracje email:</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Serwis</th>
                    <th>Email serwisu</th>
                    <th>Email opiekuna</th>
                    <th>Akcje</th>
                  </tr>
                </thead>
                <tbody id="emailConfigTableBody">
                  <!-- Konfiguracje będą ładowane dynamicznie -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Zamknij
          </button>
          <button type="button" class="btn btn-primary" onclick="saveEmailConfiguration()" id="saveEmailConfigBtn" disabled>
            <i class="bi bi-check-circle"></i> Zapisz konfigurację
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal potwierdzenia -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-question-circle"></i> Potwierdzenie</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmationModalBody">
          Czy na pewno chcesz wykonać tę operację?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle"></i> Anuluj</button>
          <button type="button" class="btn btn-primary" id="confirmButton"><i class="bi bi-check-circle"></i> Potwierdź</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal wyszukiwania numerów ram -->
  <div class="modal fade" id="frameSearchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-upc-scan"></i> Wyszukiwanie numerów ram</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="frameSearchLoading" class="text-center py-3 d-none">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Wyszukiwanie...</span>
            </div>
            <p>Trwa wyszukiwanie numerów ram...</p>
          </div>
          <div id="frameSearchResults">
            <!-- Tu będą wyniki wyszukiwania -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal wyszukiwania części -->
  <div class="modal fade" id="partsSearchModal" tabindex="-1" aria-modal="true" aria-labelledby="partsSearchModalTitle">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="partsSearchModalTitle"><i class="bi bi-search"></i> Wyszukiwanie części</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col">
              <div class="input-group">
                <input type="text" class="form-control" id="partsSearchInput" placeholder="Wpisz kod lub nazwę części...">
                <button class="btn btn-primary" type="button" id="partsSearchBtn" onclick="searchPartsInModal(document.getElementById('partsSearchInput').value)">
                  <i class="bi bi-search"></i> Szukaj
                </button>
              </div>
            </div>
          </div>
          <!-- Kontener na kafelki kategorii produktów -->
          <div id="partCategoriesContainer" class="mb-3">
            <!-- Tutaj będą wyświetlane kafelki kategorii produktów -->
          </div>
          <div id="partsSearchLoading" class="text-center py-3 d-none">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Ładowanie...</span>
            </div>
            <p>Trwa ładowanie wszystkich części...</p>
          </div>
          <div id="partsSearchNoResults" class="alert alert-info d-none">
            Nie znaleziono części pasujących do wyszukiwania.
          </div>
          <div id="partsSearchResults" class="row mt-3">
            <!-- Tu będą wyniki wyszukiwania -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal szczegółów części -->
  <div class="modal fade" id="partDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="partDetailTitle"><i class="bi bi-gear"></i> Szczegóły części</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-5 text-center mb-3">
              <img id="partDetailImage" class="product-detail-image img-fluid" src="" alt="Zdjęcie części">
            </div>
            <div class="col-md-7">
              <h5 id="partDetailName"></h5>
              <p id="partDetailCode" class="text-muted"></p>
              <p id="partDetailCategory"></p>
              <div class="mb-3">
                <label for="partQuantity" class="form-label"><i class="bi bi-123"></i> Ilość:</label>
                <input type="number" class="form-control" id="partQuantity" min="1" value="1">
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle"></i> Anuluj</button>
          <button type="button" class="btn btn-primary" id="addPartToOrderBtn"><i class="bi bi-cart-plus"></i> Dodaj część</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal dla niestandardowej usługi "Inne" -->
  <div class="modal fade" id="customServiceModal" tabindex="-1" aria-labelledby="customServiceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="customServiceModalLabel"><i class="bi bi-plus-circle"></i> Dodaj inną usługę</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="customServiceName" class="form-label">Nazwa usługi:</label>
            <input type="text" class="form-control" id="customServiceName" placeholder="Wprowadź nazwę usługi">
          </div>
          <div class="mb-3">
            <label for="customServiceDescription" class="form-label">Opis usługi:</label>
            <textarea class="form-control" id="customServiceDescription" rows="3" placeholder="Wprowadź szczegółowy opis usługi"></textarea>
          </div>
          <div class="mb-3">
            <label for="customServicePrice" class="form-label">Cena usługi:</label>
            <div class="input-group">
              <input type="number" class="form-control" id="customServicePrice" placeholder="0.00" min="0" step="0.01">
              <span class="input-group-text">zł</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle"></i> Anuluj</button>
          <button type="button" class="btn btn-success" id="addCustomServiceBtn"><i class="bi bi-plus-circle"></i> Dodaj usługę</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for parts selection and filtering -->
  <div class="modal fade" id="partsModal" tabindex="-1" aria-labelledby="partsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="partsModalLabel">Wybór części do zamówienia</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-8">
              <div class="input-group">
                <input type="text" id="searchTermModal" class="form-control" placeholder="Wyszukaj części...">
                <button class="btn btn-primary" type="button" id="searchButtonModal">
                  <i class="bi bi-search"></i> Szukaj
                </button>
              </div>
            </div>
            <div class="col-md-4">
              <select id="partCategoryFilterModal" class="form-select">
                <option value="">Wszystkie kategorie</option>
                <!-- Product categories will be loaded here -->
              </select>
            </div>
          </div>
          
          <!-- Category filter tiles moved from main view to modal -->
          <div class="row mb-3" id="categoryTilesContainerModal">
            <div class="mb-2 fw-bold">
              <i class="bi bi-funnel"></i> Filtruj według kategorii produktu:
            </div>
            <div class="d-flex flex-wrap gap-2">
              <!-- Tutaj będą wyświetlane kafelki kategorii produktów -->
            </div>
          </div>
          
          <div class="table-container">
            <table class="table table-striped table-hover" id="partsTableModal">
              <thead>
                <tr>
                  <th>Kod</th>
                  <th>Nazwa części</th>
                  <th>Cena</th>
                  <th>Akcje</th>
                </tr>
              </thead>
              <tbody>
                <!-- Parts will be dynamically loaded here -->
              </tbody>
            </table>
          </div>
          <div id="noPartsFoundModal" class="alert alert-info mt-3 d-none">
            Nie znaleziono części spełniających kryteria wyszukiwania
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal dodawania nowego numeru ramy -->
  <div class="modal fade" id="newFrameNumberModal" tabindex="-1" aria-labelledby="newFrameNumberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="newFrameNumberModalLabel"><i class="bi bi-upc-scan"></i> Dodaj nowy numer ramy</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="newFrameNumber" class="form-label required-field">Numer ramy:</label>
            <input type="text" class="form-control" id="newFrameNumber" placeholder="Wprowadź numer ramy" required>
          </div>
          <div class="text-muted small">
            <p><i class="bi bi-info-circle"></i> Numer zostanie powiązany z oddziałem: <strong id="departmentNameDisplay"></strong></p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle"></i> Anuluj</button>
          <button type="button" class="btn btn-success" id="saveNewFrameNumberBtn"><i class="bi bi-check-circle"></i> Zapisz</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Kontener na powiadomienia -->
  <div id="notification-container"></div>

  <!-- Nowy modal końcowego podsumowania raportu -->
  <div class="modal fade" id="finalSummaryModal" tabindex="-1" role="dialog" aria-labelledby="finalSummaryModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="finalSummaryModalLabel">Podsumowanie raportu</h5>
        </div>
        <div class="modal-body">
          <div class="mb-4 text-center">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
            <h4 class="mt-3">Raport został pomyślnie utworzony</h4>
          </div>
          
          <div class="alert alert-success mb-3">
            <p><strong><i class="bi bi-envelope-check"></i> Maile:</strong> Potwierdzenia zostały wysłane na podane adresy email.</p>
          </div>
          
          <div class="alert alert-success mb-3">
            <p><strong><i class="bi bi-database-check"></i> Dane:</strong> Wszystkie dane zostały prawidłowo zapisane.</p>
          </div>
          
          <div class="alert alert-success mb-3">
            <p><strong><i class="bi bi-images"></i> Zdjęcia:</strong> Wszystkie zdjęcia zostały prawidłowo zapisane.</p>
          </div>
          
          <div class="bg-light p-3 rounded text-center mb-3">
            <h5>Numer ID raportu</h5>
            <h3 id="reportIdDisplay" class="text-primary">12345</h3>
          </div>
        </div>        <div class="modal-footer">
          <a href="https://cargobikeserwis.com/dpd/" class="btn btn-primary btn-lg w-100" id="closeFinalSummaryBtn">
            <i class="bi bi-check-circle me-2"></i>Zamknij
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // System powiadomień - pełna implementacja zamiast komentarza
    const notifications = {
      container: document.getElementById('notification-container'),
      
      show(message, type = 'info', title = '', duration = 3000) {
        // Ustaw domyślny tytuł według typu
        if (!title) {
          switch(type) {
            case 'success': title = 'Sukces!'; break;
            case 'error': title = 'Błąd!'; break;
            case 'warning': title = 'Ostrzeżenie!'; break;
            case 'info': title = 'Informacja'; break;
          }
        }
        
        // Utwórz element powiadomienia
        const notification = document.createElement('div');
        notification.className = `toast-notification toast-${type}`;
        notification.innerHTML = `
          <div class="toast-notification-header">
            <h5 class="toast-notification-title">${title}</h5>
            <button type="button" class="toast-notification-close">&times;</button>
          </div>
          <p class="toast-notification-body">${message}</p>
        `;
        
        // Dodaj obsługę zamykania
        notification.querySelector('.toast-notification-close').addEventListener('click', () => {
          this.close(notification);
        });
        
        // Dodaj do kontenera
        this.container.appendChild(notification);
        
        // Automatyczne zamykanie po określonym czasie
        if (duration > 0) {
          setTimeout(() => {
            this.close(notification);
          }, duration);
        }
        
        return notification;
      },
      
      success(message, title = '', duration = 3000) {
        return this.show(message, 'success', title, duration);
      },
      
      error(message, title = '', duration = 3000) {
        return this.show(message, 'error', title, duration);
      },
      
      warning(message, title = '', duration = 3000) {
        return this.show(message, 'warning', title, duration);
      },
      
      info(message, title = '', duration = 3000) {
        return this.show(message, 'info', title, duration);
      },
      
      close(notification) {
        notification.style.animation = 'fade-out 0.5s';
        setTimeout(() => {
          if (notification.parentNode === this.container) {
            this.container.removeChild(notification);
          }
        }, 500);
      }
    };    // Global variables initialization
    let currentUser = null;
    let selectedProduct = null;
    let selectedService = null;
    let orderItems = [];
    let serviceItems = []; // Initialize serviceItems as an array
    let partItems = [];
    let beforeImages = [];
    let afterImages = [];
    let cennikId = null;
    let appImages = {};
    let allLoadedProducts = [];
    let allLoadedServices = [];    let currentCategory = '';
    let modals = {};

    // Funkcja walidacji adresu email
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // Funkcje do kontrolowania stanu przycisków typu serwisu
    function disableServiceTypeButtons() {
      const basicCard = document.getElementById('serviceTypeBasicCard');
      const advancedCard = document.getElementById('serviceTypeAdvancedCard');
      
      if (basicCard) basicCard.classList.add('disabled');
      if (advancedCard) advancedCard.classList.add('disabled');
      
      // Pokaż wskaźnik ładowania
      const loadingIndicator = document.getElementById('serviceTypeLoadingIndicator');
      if (loadingIndicator) {
        loadingIndicator.classList.remove('d-none');
      }
    }

    function enableServiceTypeButtons() {
      const basicCard = document.getElementById('serviceTypeBasicCard');
      const advancedCard = document.getElementById('serviceTypeAdvancedCard');
      
      if (basicCard) basicCard.classList.remove('disabled');
      if (advancedCard) advancedCard.classList.remove('disabled');
      
      // Ukryj wskaźnik ładowania
      const loadingIndicator = document.getElementById('serviceTypeLoadingIndicator');
      if (loadingIndicator) {
        loadingIndicator.classList.add('d-none');
      }
    }

    function checkDataLoadingState() {
      // Sprawdź czy wszystkie wymagane dane są załadowane
      const hasUser = currentUser !== null;
      const hasCennikId = cennikId !== null;
      const hasBasicData = document.getElementById('service').value && 
                          document.getElementById('repairCategory').value && 
                          document.getElementById('operator').value && 
                          document.getElementById('department').value;
      
      console.log('Sprawdzanie stanu ładowania danych:', {
        hasUser,
        hasCennikId,
        hasBasicData,
        cennikId
      });
      
      return hasUser && hasCennikId && hasBasicData;
    }

    function updateServiceTypeButtonsState() {
      if (checkDataLoadingState()) {
        enableServiceTypeButtons();
        console.log('Przyciski typu serwisu odblokowane - dane załadowane');
      } else {
        disableServiceTypeButtons();
        console.log('Przyciski typu serwisu zablokowane - brak wszystkich wymaganych danych');
      }
    }

    // Funkcja konwertująca URL z Google Drive na miniaturę - poprawiona wersja z większą rozdzielczością
    function convertToThumbnail(url) {
      if (!url) return 'https://placeholder.pics/svg/400/DEDEDE/555555/Brak+zdjecia';
      
      if (url.indexOf('drive.google.com') > -1) {
        const fileId = extractFileId(url);
        if (fileId) {
          // Zwiększona rozdzielczość miniatury z Google Drive
          return "https://drive.google.com/thumbnail?id=" + fileId + "&sz=w400-h400";
        }
      }
      return url;
    }
    
    // Funkcja do wyodrębnienia identyfikatora pliku z URL Google Drive
    function extractFileId(driveUrl) {
      // Format: https://drive.google.com/file/d/FILE_ID/view
      const match = driveUrl.match(/\/d\/([^\/]+)/);
      if (match && match[1]) {
        return match[1];
      }
      
      // Format: https://drive.google.com/open?id=FILE_ID
      const idParam = driveUrl.match(/[?&]id=([^&]+)/);
      if (idParam && idParam[1]) {
        return idParam[1];
      }
      
      return null;
    }

    // Poprawiona funkcja do bezpiecznej inicjalizacji selectów dla urządzeń mobilnych
    function initAllSelect2() {
      setTimeout(function() {
        try {
          // Wykryj czy urządzenie jest mobilne
          const isMobile = window.matchMedia("only screen and (max-width: 768px)").matches;
          
          // Konfiguracja dla Select2
          const select2Config = {
            width: '100%',
            language: {
              noResults: function() {
                return "Brak wyników";
              }
            },
            dropdownAutoWidth: true,
            allowClear: true
          };
          
          // Dodatkowa konfiguracja dla urządzeń mobilnych
          if (isMobile) {
            // Nie używaj dropdownParent: document.body - to powoduje problem!
            // Zamiast tego pozwól Select2 umieścić dropdown tam gdzie należy
            
            // Dodaj styl dla mobilnych urządzeń, jeśli jeszcze nie istnieje
            if (!document.getElementById('select2-mobile-fix')) {
              const styleSheet = document.createElement('style');
              styleSheet.id = 'select2-mobile-fix';
              styleSheet.textContent = `
                .select2-dropdown {
                  max-width: 100% !important;
                  width: auto !important; 
                }
                .select2-container--open {
                  z-index: 9999;
                }
                .select2-container--open .select2-dropdown {
                  width: auto !important;
                  min-width: 100% !important;
                  max-width: calc(100vw - 20px) !important;
                  position: absolute !important;
                  left: auto !important; 
                }
                .select2-container--default .select2-results > .select2-results__options {
                  max-height: 40vh !important;
                  overflow-y: auto;
                }
                .select2-container--default .select2-search--dropdown .select2-search__field {
                  width: 100% !important;
                  box-sizing: border-box;
                }
                .select2-search {
                  width: 100% !important;
                }
                .select2-results__option {
                  padding: 10px 8px !important;
                  min-height: 44px !important;
                  display: flex !important;
                  align-items: center !important;
                }
              `;
              document.head.appendChild(styleSheet);
            }
          }
          
          // Inicjalizacja wszystkich elementów select jako Select2
          $('select').each(function() {
            const $select = $(this);
            
            // Sprawdź czy Select2 nie jest już inicjalizowany
            if (!$select.hasClass('select2-hidden-accessible')) {
              // Utwórz kopię konfiguracji dla tego konkretnego selecta
              let thisConfig = {...select2Config};
              
              // Na urządzeniach mobilnych, znajdź rodzica dla dropdown
              if (isMobile) {
                // Znajdź najbliższy element formularza, który powinien zawierać dropdown
                const $formGroup = $select.closest('.form-group, .mb-3, .input-group');
                if ($formGroup.length) {
                  // Znajdź najpewniejszego rodzica - element który ma pozycję relative lub absolute
                  let $parent = $formGroup;
                  if (!$parent.css('position') || $parent.css('position') === 'static') {
                    // Ustaw pozycję relative aby dropdown był prawidłowo umieszczony
                    $parent.css('position', 'relative');
                  }
                  
                  // Ustaw rodzica tylko jeśli element istnieje
                  thisConfig.dropdownParent = $parent;
                }
              }
              
              // Inicjalizuj Select2 z konfiguracją
              $select.select2(thisConfig);
              
              // Dodatkowa obsługa dla urządzeń mobilnych
              if (isMobile) {
                // Otwieranie wyskakującego menu na dotknięcie
                $select.on('select2:open', function() {
                  // Poczekaj aż DOM się zaktualizuje
                  setTimeout(function() {
                    // Zwiększ z-index dla aktualnie otwartego dropdown
                    $('.select2-container--open').css('z-index', 9999);
                    
                    // Znajdź pole wyszukiwania i ustaw focus
                    $('.select2-search__field').focus();
                    
                    // Dostosuj wysokość opcji w menu
                    $('.select2-results__option').css({
                      'min-height': '44px',
                      'padding': '10px 8px',
                      'display': 'flex',
                      'align-items': 'center'
                    });
                    
                    // Przewiń do elementu select aby był widoczny
                    // To ważne - zapewnia że dropdown pojawi się we właściwym miejscu
                    const selectOffset = $select.offset();
                    if (selectOffset) {
                      // Przewiń tak, aby element był widoczny, ale z marginesem u góry
                      window.scrollTo({
                        top: Math.max(0, selectOffset.top - 120),
                        behavior: 'smooth'
                      });
                    }
                  }, 10);
                });
                
                // Napraw problemy z przewijaniem strony podczas przewijania dropdown
                $(document).on('scroll touchmove mousewheel', '.select2-results__options', function(e) {
                  e.stopPropagation();
                });
              }
            }
          });
          
          console.log("Wszystkie selekty Select2 poprawnie zainicjalizowane" + (isMobile ? " dla urządzeń mobilnych" : ""));
        } catch(e) {
          console.error("Błąd inicjalizacji Select2:", e);
        }
      }, 200); // Zwiększono opóźnienie dla pewności, że DOM jest gotowy
    }

    // Funkcja do reinicjalizacji Select2 po zmianie zawartości strony
    function reinitSelect2() {
      // Zniszcz istniejące wystąpienia Select2
      $('select.select2-hidden-accessible').select2('destroy');
      
      // Zainicjuj ponownie
      initAllSelect2();
    }

    // Funkcja pobierająca obrazy z arkusza - zaktualizowana o B4 i B5
    function loadAppImages() {
      showLoading("Ładowanie zasobów aplikacji...");
      google.script.run
        .withSuccessHandler(function(images) {
          appImages = images;
          console.log("Załadowano obrazy:", images);
          
          // Ustawienie logo z konwersją na miniatury - najpierw sprawdź czy element istnieje
          const loginLogoImg = document.getElementById('loginLogoImg');
          if (loginLogoImg) {
            loginLogoImg.src = convertToThumbnail(appImages.logoA2);
          }
          
          // Dodane ustawienie logo nagłówka
          const headerLogoImg = document.getElementById('headerLogoImg');
          if (headerLogoImg) {
            headerLogoImg.src = convertToThumbnail(appImages.logoA2);
          }
          
          // Ustawienie obrazów banera
          const bannerImage1 = document.getElementById('bannerImage1');
          if (bannerImage1) {
            console.log("Ustawianie obrazu banera 1:", appImages.logoB2);
            bannerImage1.src = convertToThumbnail(appImages.logoB2 || '');
            bannerImage1.onerror = function() { this.src = 'https://placeholder.pics/svg/200/DEDEDE/555555/Brak+zdjecia'; };
          }
          
          const bannerImage2 = document.getElementById('bannerImage2');
          if (bannerImage2) {
            console.log("Ustawianie obrazu banera 2:", appImages.logoB3);
            bannerImage2.src = convertToThumbnail(appImages.logoB3 || '');
            bannerImage2.onerror = function() { this.src = 'https://placeholder.pics/svg/200/DEDEDE/555555/Brak+zdjecia'; };
          }
          
          const bannerImage3 = document.getElementById('bannerImage3');
          if (bannerImage3) {
            console.log("Ustawianie obrazu banera 3:", appImages.logoB4);
            bannerImage3.src = convertToThumbnail(appImages.logoB4 || '');
            bannerImage3.onerror = function() { this.src = 'https://placeholder.pics/svg/200/DEDEDE/555555/Brak+zdjecia'; };
          }
          
          // Dodane ustawienie czwartego obrazka z baneru
          const bannerImage4 = document.getElementById('bannerImage4');
          if (bannerImage4) {
            console.log("Ustawianie obrazu banera 4:", appImages.logoB5);
            bannerImage4.src = convertToThumbnail(appImages.logoB5 || '');
            bannerImage4.onerror = function() { this.src = 'https://placeholder.pics/svg/200/DEDEDE/555555/Brak+zdjecia'; };
          }
          
          // Ustaw jednolite tło ekranu logowania zamiast obrazka
          const loginWrapper = document.getElementById('loginWrapper');
          if (loginWrapper) {
            loginWrapper.style.backgroundImage = ''; // Usunięcie obrazka tła
            loginWrapper.style.backgroundColor = '#f8f9fa'; // Ustawienie jednolitego koloru
          }
          
          hideLoading();
          
          // Pokaż ekran logowania
          if (loginWrapper) {
            loginWrapper.classList.remove('hidden');
          }
          
          const appContent = document.getElementById('appContent');
          if (appContent) {
            appContent.classList.add('hidden');
          }
        })
        .withFailureHandler(function(error) {
          console.error("Błąd wczytywania obrazów:", error);
          hideLoading();
          
          // Pokaż ekran logowania nawet w przypadku błędu
          const loginWrapper = document.getElementById('loginWrapper');
          if (loginWrapper) {
            loginWrapper.classList.remove('hidden');
            loginWrapper.style.backgroundImage = ''; // Usunięcie obrazka tła
            loginWrapper.style.backgroundColor = '#f8f9fa'; // Ustawienie jednolitego koloru
          }
          
          const appContent = document.getElementById('appContent');
          if (appContent) {
            appContent.classList.add('hidden');
          }
        })
        .getAppImages();
    }

    // Funkcje pomocnicze
    function showLoading(message = "Proszę czekać...") {
      const loadingMessage = document.getElementById('loadingMessage');
      if (loadingMessage) {
        loadingMessage.innerText = message;
      }
      
      if (modals && modals.loading) {
        try {
          modals.loading.show();
        } catch (e) {
          console.warn("Nie można wyświetlić modalu ładowania:", e);
        }
      }
    }
    
    function hideLoading() {
      if (modals && modals.loading) {
        modals.loading.hide();
      }
    }
    
    function showError(message) {
      notifications.error(message);
    }
    
    // Funkcja do bezpiecznej inicjalizacji selectów - dodana dla lepszej kompatybilności z urządzeniami mobilnymi
    function initAllSelect2() {
      setTimeout(function() {
        try {
          // Funkcja pomocnicza - bezpieczna inicjalizacja
          function initSingleSelect2(selector, placeholder) {
            const element = document.getElementById(selector);
            if (!element) return;
            
            try {
              // Sprawdzenie czy element jest już zainicjowany przez Select2
              const instance = $('#' + selector).data('select2');
              if (instance) {
                $('#' + selector).select2('destroy');
              }
            } catch (e) {
              console.log(`Inicjalizacja Select2 dla ${selector}`);
            }
            
            // Inicjalizacja z parametrami dla mobile
            $('#' + selector).select2({
              width: '100%',
              placeholder: placeholder || "Wybierz",
              allowClear: true,
              dropdownCssClass: "select2-dropdown-mobile",
              dropdownParent: $('body') // Ważne dla poprawnego wyświetlania na urządzeniach mobilnych
            });
          }
          
          // Inicjalizacja wszystkich selektów
          const selects = [
            {id: 'service', placeholder: "Wybierz serwis"},
            {id: 'repairCategory', placeholder: "Wybierz kategorię"},
            {id: 'operator', placeholder: "Wybierz operatora"},
            {id: 'department', placeholder: "Wybierz oddział"}
          ];
          
          selects.forEach(select => {
            initSingleSelect2(select.id, select.placeholder);
          });
          
          console.log("Wszystkie selekty Select2 poprawnie zainicjalizowane");
        } catch(e) {
          console.warn('Błąd podczas inicjalizacji selektów Select2:', e);
        }
      }, 500);
    }

    // Inicjalizacja aplikacji
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // Upewnij się, że kontener powiadomień jest zainicjalizowany
        if (!notifications.container) {
          notifications.container = document.getElementById('notification-container');
        }

        // Inicjalizacja modalów bootstrapowych - bezpieczna inicjalizacja
        modals = {};
        
        // Bezpieczna inicjalizacja modalów
        const modalElements = {
          productDetail: document.getElementById('productDetailModal'),
          loading: document.getElementById('loadingModal'),
          confirmation: document.getElementById('confirmationModal'),
          productSearch: document.getElementById('productSearchModal'),
          serviceSearch: document.getElementById('serviceSearchModal'),
          serviceDetail: document.getElementById('serviceDetailModal'),
          frameSearch: document.getElementById('frameSearchModal'),
          partsSearch: document.getElementById('partsSearchModal'),
          partDetail: document.getElementById('partDetailModal'),
          customService: document.getElementById('customServiceModal'),
          partsModal: document.getElementById('partsModal'),
          newFrameNumber: document.getElementById('newFrameNumberModal'),
          finalSummary: document.getElementById('finalSummaryModal')
        };
          // Inicjalizuj tylko te modale, które istnieją w DOM
        for (const [key, element] of Object.entries(modalElements)) {
          if (element) {
            try {
              modals[key] = new bootstrap.Modal(element);
              console.log(`Modal ${key} initialized`);
            } catch (err) {
              console.error(`Error initializing ${key} modal:`, err);
            }
          } else {
            console.warn(`Modal element ${key} not found in DOM`);
          }
        }
      
        // Bezpieczne dodawanie event listenerów
        const attachEventListener = (selector, event, handler) => {
          const element = document.getElementById(selector);
          if (element) {
            element.addEventListener(event, handler);
          }
        };
      
        // Obsługa przycisku otwierającego modal wyszukiwania produktów
        attachEventListener('openProductSearchBtn', 'click', function() {
          const searchInput = document.getElementById('productSearchInput');
          const searchResults = document.getElementById('productSearchResults');
          const noResults = document.getElementById('productSearchNoResults');
          const loading = document.getElementById('productSearchLoading');
          
          if (searchInput) searchInput.value = '';
          if (searchResults) searchResults.innerHTML = '';
          if (noResults) noResults.classList.add('d-none');
          
          if (loading) {
            loading.classList.remove('d-none');
            const loadingText = loading.querySelector('p');
            if (loadingText) loadingText.innerText = 'Trwa ładowanie wszystkich produktów...';
          }
          
          if (modals.productSearch) modals.productSearch.show();
          
          // Automatycznie załaduj wszystkie produkty po otwarciu modalu
          loadAllProducts();
          loadProductCategories();
        });

        // Obsługa przycisku otwierającego modal wyszukiwania usług
        attachEventListener('openServiceSearchBtn', 'click', function() {
          const searchInput = document.getElementById('serviceSearchInput');
          const searchResults = document.getElementById('serviceSearchResults');
          const noResults = document.getElementById('serviceSearchNoResults');
          const loading = document.getElementById('serviceSearchLoading');
          
          if (searchInput) searchInput.value = '';
          if (searchResults) searchResults.innerHTML = '';
          if (noResults) noResults.classList.add('d-none');
          
          if (loading) {
            loading.classList.remove('d-none');
            const loadingText = loading.querySelector('p');
            if (loadingText) loadingText.innerText = 'Trwa ładowanie wszystkich usług...';
          }
          
          if (modals.serviceSearch) modals.serviceSearch.show();
          
          // Automatycznie załaduj wszystkie usługi po otwarciu modalu
          loadAllServices();
        });

        // Obsługa przycisku otwierającego modal wyszukiwania części
        attachEventListener('openPartSearchBtn', 'click', function() {
          const searchInput = document.getElementById('partsSearchInput');
          const searchResults = document.getElementById('partsSearchResults');
          const noResults = document.getElementById('partsSearchNoResults');
          const loading = document.getElementById('partsSearchLoading');
          
          if (searchInput) searchInput.value = '';
          if (searchResults) searchResults.innerHTML = '';
          if (noResults) noResults.classList.add('d-none');
          
          if (loading) {
            loading.classList.remove('d-none');
            const loadingText = loading.querySelector('p');
            if (loadingText) loadingText.innerText = 'Trwa ładowanie wszystkich części...';
          }
          
          if (modals.partsSearch) modals.partsSearch.show();
          
          // Automatycznie załaduj wszystkie części po otwarciu modalu
          loadAllParts();
          loadPartCategories();
        });

        // Poprawiona obsługa przycisku dodawania niestandardowej usługi - tylko jedno miejsce
        attachEventListener('addCustomServiceBtn', 'click', addCustomService);
      
        // Obsługa klawisza Enter w polu wyszukiwania
        attachEventListener('productSearchInput', 'keypress', function(e) {
          if (e.key === 'Enter') {
            const searchTerm = this.value.trim();
            if (searchTerm.length < 2) {
              notifications.warning("Wpisz co najmniej 2 znaki aby rozpocząć wyszukiwanie", "Za krótkie zapytanie");
              return;
            }
            searchProductsInModal(searchTerm);
          }
        });

        attachEventListener('serviceSearchInput', 'keypress', function(e) {
          if (e.key === 'Enter') {
            const searchTerm = this.value.trim();
            if (searchTerm.length < 2) {
              notifications.warning("Wpisz co najmniej 2 znaki aby rozpocząć wyszukiwanie", "Za krótkie zapytanie");
              return;
            }
            searchServicesInModal(searchTerm);
          }
        });

        attachEventListener('partsSearchInput', 'keypress', function(e) {
          if (e.key === 'Enter') {
            const searchTerm = this.value.trim();
            if (searchTerm.length < 2) {
              notifications.warning("Wpisz co najmniej 2 znaki aby rozpocząć wyszukiwanie", "Za krótkie zapytanie");
              return;
            }
            searchPartsInModal(searchTerm);
          }
        });
      
        // Dodanie obsługi filtrowania na żywo podczas wpisywania - naprawione
        const searchInput = document.getElementById('productSearchInput');
        if (searchInput) {
          searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.trim();
            if (searchTerm.length >= 2) {
              filterDisplayedProducts(searchTerm);
            } else if (searchTerm.length === 0) {
              // Gdy pole jest puste, przywróć wszystkie produkty
              resetProductsFilter();
            }
          });
        }

        const serviceSearchInput = document.getElementById('serviceSearchInput');
        if (serviceSearchInput) {
          serviceSearchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.trim();
            if (searchTerm.length >= 2) {
              filterDisplayedServices(searchTerm);
            } else if (searchTerm.length === 0) {
              // Gdy pole jest puste, przywróć wszystkie usługi
              resetServicesFilter();
            }
          });
        }

        const partsSearchInput = document.getElementById('partsSearchInput');
        if (partsSearchInput) {
          partsSearchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.trim();
            if (searchTerm.length >= 2) {
              filterDisplayedParts(searchTerm);
            } else if (searchTerm.length === 0) {
              // Gdy pole jest puste, przywróć wszystkie części
              resetPartsFilter();
            }
          });
        }
      
        // Dodanie handlera dodawania produktu do zamówienia
        attachEventListener('addToOrderBtn', 'click', function() {
          addToOrder();
        });

        // Dodanie handlera dodawania usługi do zamówienia
        attachEventListener('addServiceToOrderBtn', 'click', function() {
          addServiceToOrder();
        });

        // Dodanie handlera dodawania części do zamówienia
        attachEventListener('addPartToOrderBtn', 'click', function() {
          addPartToOrder();
        });
      
        // Dodanie handlera logowania po naciśnięciu Enter
        attachEventListener('password', 'keypress', function(e) {
          if (e.key === 'Enter') {
            handleLogin();
          }
        });
      
        // Dodanie obsługi bezpośredniej aktywacji po zmianie wartości
        attachEventListener('repairCategory', 'change', function() {
          console.log("Zdarzenie change wywołane na repairCategory");
          setTimeout(() => {
            handleCategoryChange();
          }, 50); // Małe opóźnienie dla stabilności
        });
      
        attachEventListener('operator', 'change', function() {
          console.log("Zdarzenie change wywołane na operator");
          setTimeout(() => {
            handleOperatorChange();
          }, 50); // Małe opóźnienie dla stabilności
        });
      
        // Inicjalizacja tooltipów dla pól wyboru
        try {
          $('[data-bs-toggle="tooltip"]').tooltip();
        } catch (e) {
          console.warn("Nie można zainicjalizować tooltipów:", e);
        }
      
        // Załaduj obrazy i rozpocznij aplikację
        loadAppImages();

        // Poprawiona inicjalizacja Select2 dla dropdownów - zapobiega błędom
        initAllSelect2();

        // Inicjalizacja panelu zdjęć
        setTimeout(() => {
          try {
            initImageUpload();
            console.log("Panel zdjęć zainicjalizowany");
          } catch (e) {
            console.error("Błąd podczas inicjalizacji panelu zdjęć:", e);
          }
        }, 1000); // Opóźnienie dla pewności, że DOM jest gotowy

        // Dodanie obsługi przycisku zapisz nowy numer ramy
        const saveNewFrameNumberBtn = document.getElementById('saveNewFrameNumberBtn');
        if (saveNewFrameNumberBtn) {
          saveNewFrameNumberBtn.addEventListener('click', handleNewFrameNumberSave);
        }

        // Sprawdzanie czy przebieg (km) nie jest ujemny
        const bikeMileageInput = document.getElementById('bikeMileage');
        if (bikeMileageInput) {
          bikeMileageInput.addEventListener('input', function(e) {
            const value = parseInt(e.target.value);
            if (value < 0) {
              e.target.value = 0;
              notifications.warning('Przebieg (km) nie może być ujemny', 'Nieprawidłowa wartość');
            }
          });
          
          // Dodatkowa walidacja przy submicie formularza
          document.getElementById('submitOrderBtn').addEventListener('click', function(e) {
            const mileage = parseInt(bikeMileageInput.value);
            if (mileage < 0) {
              e.preventDefault();
              bikeMileageInput.value = 0;
              notifications.warning('Przebieg (km) nie może być ujemny', 'Nieprawidłowa wartość');
              return false;
            }
          }, { once: false });
        }
        
        // Add event listener for the complete order button
        document.getElementById('completeOrderBtn').addEventListener('click', function() {
            window.location.href = 'https://cargobikeserwis.com/dpd/';
        });
        
      } catch (e) {
        console.error('Błąd podczas inicjalizacji aplikacji', e);
        // Próba wyświetlenia strony logowania w przypadku błędu
        const loginWrapper = document.getElementById('loginWrapper');
        if (loginWrapper) {
          loginWrapper.classList.remove('hidden');
          loginWrapper.style.backgroundImage = "url('https://via.placeholder.com/1920x1080?text=Tło+logowania')";
        }
        
        const loginLogoImg = document.getElementById('loginLogoImg');
        if (loginLogoImg) {
          loginLogoImg.src = 'https://via.placeholder.com/200x80?text=CARGO+BIKE+SERWIS';
        }
      }
    });
    
    // Funkcje logowania
    function handleLogin() {
      const login = document.getElementById('login').value;
      const password = document.getElementById('password').value;
      
      if (!login || !password) {
        document.getElementById('loginError').innerText = "Wprowadź login i hasło";
        document.getElementById('loginError').classList.remove('hidden');
        return;
      }
      
      showLoading("Logowanie...");
      
      google.script.run
        .withSuccessHandler(handleLoginSuccess)
        .withFailureHandler(handleLoginError)
        .login(login, password);
    }
    
    // Implementacja funkcji handleLoginSuccess
    function handleLoginSuccess(result) {
      hideLoading();
      
      if (result.success) {
        currentUser = {
          serwis: result.serwis,
          rola: result.rola
        };
        
        // Ukryj panel logowania i pokaż aplikację
        document.getElementById('loginWrapper').classList.add('hidden');
        document.getElementById('appContent').classList.remove('hidden');
          // Aktualizacja info o użytkowniku
        document.getElementById('user-name').innerText = `Zalogowany jako: ${currentUser.serwis} (${currentUser.rola})`;
        
        // Pokaż przycisk konfiguracji email dla adminów
        if (currentUser.rola === 'Admin') {
          document.getElementById('emailConfigBtn').classList.remove('hidden');
        }
        
        // Pokaż powiadomienie o pomyślnym zalogowaniu
        notifications.success(`Zalogowano jako: ${currentUser.serwis}`, 'Witaj w systemie zamówień!');
        
        // Wczytaj dane serwisowe
        loadServices();
      } else {
        document.getElementById('loginError').innerText = result.message;
        document.getElementById('loginError').classList.remove('hidden');
      }
    }

    // Implementacja funkcji handleLoginError
    function handleLoginError(error) {
      hideLoading();
      document.getElementById('loginError').innerText = "Błąd podczas logowania: " + (error.message || "Nieznany błąd");
      document.getElementById('loginError').classList.remove('hidden');
    }

    // Funkcja obsługi błędów danych
    function handleDataError(error) {
      hideLoading();
      console.error("Błąd pobierania danych:", error);
      notifications.error(`Błąd pobierania danych: ${error.message || "Nieznany błąd"}`, "Problem z komunikacją");
      
      // Sprawdzenie statusu sieci
      if (!navigator.onLine) {
        notifications.error("Brak połączenia internetowego. Sprawdź swoje połączenie i spróbuj ponownie.", "Brak internetu");
      }
    }

    // Funkcja ładująca serwisy
    function loadServices() {
      showLoading("Wczytywanie serwisów...");
      
      google.script.run
        .withSuccessHandler(handleServicesLoaded)
        .withFailureHandler(handleDataError)
        .getServices();
    }

    // Minimalna implementacja handleServicesLoaded
    function handleServicesLoaded(result) {
      hideLoading();
      
      if (result && result.success) {
        const serviceSelect = document.getElementById('service');
        if (serviceSelect) {
          serviceSelect.innerHTML = '<option value="">Wybierz serwis</option>';
          
          if (currentUser && currentUser.rola !== 'Admin') {
            // Dla zwykłego użytkownika - ustawiony serwis i zablokowana edycja
            const option = document.createElement('option');
            option.value = currentUser.serwis;
            option.textContent = currentUser.serwis;
            serviceSelect.appendChild(option);
            serviceSelect.value = currentUser.serwis;
            serviceSelect.disabled = true; // Zablokowanie edycji
            
            setTimeout(() => {
              const event = new Event('change');
              serviceSelect.dispatchEvent(event);
              notifications.info(`Załadowano serwis: ${currentUser.serwis}`, "Serwis wybrany");
            }, 100);
          } else if (result.services && Array.isArray(result.services)) {
            // Dla administratora - możliwość wyboru serwisu
            result.services.forEach(serwis => {
              const option = document.createElement('option');
              option.value = serwis;
              option.textContent = serwis;
              serviceSelect.appendChild(option);
            });
            
            // Ważne - jawnie ustawiamy disabled=false dla administratora
            serviceSelect.disabled = false;
            
            // Reinicjalizacja Select2 dla administratora, aby upewnić się że pole jest odblokowane
            try {
              const select2Instance = $('#service').data('select2');
              if (select2Instance) {
                $('#service').select2('destroy');
              }
              
              $('#service').select2({
                width: '100%',
                placeholder: "Wybierz serwis",
                allowClear: true,
                dropdownParent: $('body')
              });
              
              // Upewniamy się, że element nie jest zablokowany
              $('#service').prop('disabled', false);
            } catch (e) {
              console.warn('Błąd podczas inicjalizacji Select2 dla serwisu:', e);
            }
              // Powiadomienie dla admina
            notifications.info(`Załadowano listę ${result.services.length} serwisów`, "Wybierz serwis");
          }
        }
        
        // Zaktualizuj stan przycisków typu serwisu po załadowaniu serwisów
        updateServiceTypeButtonsState();
      } else {
        showError(result?.message || "Błąd ładowania serwisów");
      }
    }

    // Funkcje obsługi konfiguracji email
    function showEmailConfigModal() {
      loadEmailConfigServices();
      loadAllEmailConfigurations();
      new bootstrap.Modal(document.getElementById('emailConfigModal')).show();
    }

    function loadEmailConfigServices() {
      const serviceSelect = document.getElementById('emailConfigService');
      serviceSelect.innerHTML = '<option value="">Wybierz serwis...</option>';
      
      // Użyj tej samej listy serwisów co w głównym formularzu
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            result.services.forEach(service => {
              const option = document.createElement('option');
              option.value = service;
              option.textContent = service;
              serviceSelect.appendChild(option);
            });
          }
        })
        .withFailureHandler(function(error) {
          console.error('Błąd ładowania serwisów:', error);
          showNotification('Błąd ładowania serwisów', 'error');
        })
        .getServices();
    }

    function loadEmailConfigForService() {
      const serviceSelect = document.getElementById('emailConfigService');
      const selectedService = serviceSelect.value;
      const configForm = document.getElementById('emailConfigForm');
      const saveBtn = document.getElementById('saveEmailConfigBtn');
      
      if (!selectedService) {
        configForm.classList.add('d-none');
        saveBtn.disabled = true;
        return;
      }
      
      configForm.classList.remove('d-none');
      saveBtn.disabled = false;
      
      // Ładuj istniejącą konfigurację dla wybranego serwisu
      google.script.run
        .withSuccessHandler(function(config) {
          const serviceEmailInput = document.getElementById('serviceEmail');
          const supervisorEmailInput = document.getElementById('supervisorEmail');
          
          if (config) {
            serviceEmailInput.value = config['Email Serwisu'] || '';
            supervisorEmailInput.value = config['Email Opiekuna'] || '';
          } else {
            serviceEmailInput.value = '';
            supervisorEmailInput.value = '';
          }
        })
        .withFailureHandler(function(error) {
          console.error('Błąd ładowania konfiguracji email:', error);
          showNotification('Błąd ładowania konfiguracji email', 'error');
        })
        .getEmailConfiguration(selectedService);
    }

    function saveEmailConfiguration() {
      const selectedService = document.getElementById('emailConfigService').value;
      const serviceEmail = document.getElementById('serviceEmail').value;
      const supervisorEmail = document.getElementById('supervisorEmail').value;
      
      if (!selectedService) {
        showNotification('Wybierz serwis', 'error');
        return;
      }
      
      const saveBtn = document.getElementById('saveEmailConfigBtn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Zapisywanie...';
      
      google.script.run
        .withSuccessHandler(function(result) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Zapisz konfigurację';
          
          if (result.success) {
            showNotification('Konfiguracja email została zapisana', 'success');
            loadAllEmailConfigurations(); // Odśwież tabelę
          } else {
            showNotification('Błąd zapisywania konfiguracji: ' + result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Zapisz konfigurację';
          console.error('Błąd zapisywania konfiguracji email:', error);
          showNotification('Błąd zapisywania konfiguracji email', 'error');
        })
        .saveEmailConfiguration(selectedService, serviceEmail, supervisorEmail);
    }

    function loadAllEmailConfigurations() {
      google.script.run
        .withSuccessHandler(function(result) {
          const tableBody = document.getElementById('emailConfigTableBody');
          tableBody.innerHTML = '';
          
          if (result.success && result.configurations.length > 0) {
            result.configurations.forEach(config => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${config.Serwis || ''}</td>
                <td>${config['Email Serwisu'] || '<span class="text-muted">-</span>'}</td>
                <td>${config['Email Opiekuna'] || '<span class="text-muted">-</span>'}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary" onclick="editEmailConfig('${config.Serwis}')">
                    <i class="bi bi-pencil"></i>
                  </button>
                </td>
              `;
              tableBody.appendChild(row);
            });
          } else {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="4" class="text-center text-muted">Brak konfiguracji email</td>';
            tableBody.appendChild(row);
          }
        })
        .withFailureHandler(function(error) {
          console.error('Błąd ładowania konfiguracji email:', error);
          const tableBody = document.getElementById('emailConfigTableBody');
          tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Błąd ładowania danych</td></tr>';
        })
        .getAllEmailConfigurations();
    }

    function editEmailConfig(serviceName) {
      const serviceSelect = document.getElementById('emailConfigService');
      serviceSelect.value = serviceName;
      loadEmailConfigForService();
    }

    // Dodanie kolejnych niezbędnych funkcji
    function logout() {
      currentUser = null;
      resetForm();
      // Pokaż ekran logowania i ukryj główną aplikację
      document.getElementById('loginWrapper').classList.remove('hidden');
      document.getElementById('appContent').classList.add('hidden');
      document.getElementById('login').value = '';
      document.getElementById('password').value = '';
      document.getElementById('loginError').classList.add('hidden');
      
      // Zaktualizuj stan przycisków typu serwisu po wylogowaniu
      updateServiceTypeButtonsState();
    }

    function resetForm() {
      document.getElementById('service').innerHTML = '<option value="">Wybierz serwis</option>';
      resetSelect('repairCategory', 'Wybierz kategorię');
      resetSelect('operator', 'Wybierz operatora');
      resetSelect('department', 'Wybierz oddział');
      document.getElementById('orderNotes').value = '';
      document.getElementById('submitOrderBtn').disabled = true;
      cennikId = null;
      orderItems = [];
      serviceItems = [];
      partItems = [];
      beforeImages = [];
      afterImages = [];      updateOrderTable();
      updateServiceTable();
      updatePartTable();
      updateImagesPreview(beforeImages, document.getElementById('beforeImagesPreview'), document.getElementById('beforeImageCount'));
      updateImagesPreview(afterImages, document.getElementById('afterImagesPreview'), document.getElementById('afterImageCount'));
      
      // Zaktualizuj stan przycisków typu serwisu po resecie formularza
      updateServiceTypeButtonsState();
    }

    function resetSelect(selectId, defaultText) {
      const select = document.getElementById(selectId);
      if (!select) return;
      
      select.innerHTML = `<option value="">${defaultText}</option>`;
      select.disabled = true;
      select.setAttribute('disabled', 'disabled'); 
      
      try {
        // Bezpieczna aktualizacja Select2
        const select2Instance = $('#' + selectId).data('select2');
        if (select2Instance) {
          $('#' + selectId).select2('destroy');
        }
        
        $('#' + selectId).select2({
          width: '100%',
          placeholder: defaultText,
          allowClear: true
        });
        $('#' + selectId).prop('disabled', true);
      } catch (e) {
        console.warn("Nie można zaktualizować Select2 dla " + selectId);
      }
    }

    // Funkcja aktualizująca tabelę zamówienia
    function updateOrderTable() {
      const tbody = document.getElementById('orderItems');
      if (!tbody) return;
      
      if (orderItems.length === 0) {
        tbody.innerHTML = '<tr id="noItemsRow"><td colspan="6" class="text-center">Brak dodanych części</td></tr>';
        updateOrderTotal();
        return;
      }
      
      tbody.innerHTML = '';
      
      orderItems.forEach((item, index) => {
        const row = document.createElement('tr');
        // Konwersja obrazu do miniatury
        const thumbnailUrl = convertToThumbnail(item.image);
        
        row.innerHTML = `
          <td>${item.code}</td>
          <td>${item.name}</td>
          <td>${item.category}</td>
          <td>
            <input type="number" class="form-control form-control-sm" value="${item.quantity}" min="1" style="width:80px; margin:0 auto;"
              onchange="updateItemQuantity(${index}, this.value)">
          </td>
          <td class="text-center">
            <img src="${thumbnailUrl}" alt="${item.name}" class="product-image">
          </td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="removeOrderItem(${index})">
              <i class="bi bi-trash"></i> Usuń
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      updateOrderTotal();
    }
    
    // Funkcja aktualizująca tabelę części z sumowaniem ilości produktów
    function updatePartTable() {
      const tbody = document.getElementById('orderItems');
      if (!tbody) return;
      
      if (partItems.length === 0) {
        tbody.innerHTML = '<tr id="noItemsRow"><td colspan="6" class="text-center">Brak dodanych części</td></tr>';
        updateOrderTotal();
        return;
      }
      
      tbody.innerHTML = '';
      
      partItems.forEach((item, index) => {
        const row = document.createElement('tr');
        // Konwersja obrazu do miniatury
        const thumbnailUrl = convertToThumbnail(item.image);
        
        row.innerHTML = `
          <td>${item.code}</td>
          <td>${item.name}</td>
          <td>${item.category}</td>
          <td>
            <input type="number" class="form-control form-control-sm" value="${item.quantity}" min="1" style="width:80px; margin:0 auto;"
              onchange="updateItemQuantity(${index}, this.value)">
          </td>
          <td class="text-center">
            <img src="${thumbnailUrl}" alt="${item.name}" class="product-image">
          </td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="removeOrderItem(${index})">
              <i class="bi bi-trash"></i> Usuń
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      updateOrderTotal();
    }

    // Funkcja aktualizująca sumę zamówienia wraz z sumowaniem ilości produktów
    function updateOrderTotal() {
      const totalQuantity = orderItems.reduce((sum, item) => sum + item.quantity, 0);
      
      const totalQuantityElement = document.getElementById('orderTotalQuantity');
      
      if (totalQuantityElement) {
        totalQuantityElement.innerText = totalQuantity;
      }
    }

    // Funkcja do wyszukiwania produktów w modalu
    function loadAllProducts() {
      try {
        if (!cennikId) {
          const searchLoading = document.getElementById('productSearchLoading');
          if (searchLoading) searchLoading.classList.add('d-none');
          notifications.warning("Najpierw wybierz wszystkie dane podstawowe", "Nie można załadować produktów");
          return;
        }

        const resultsContainer = document.getElementById('productSearchResults');
        if (resultsContainer) resultsContainer.innerHTML = '';
        
        const category = document.getElementById('repairCategory').value;
        currentCategory = category;
        
        google.script.run
          .withSuccessHandler(function(result) {
            const searchLoading = document.getElementById('productSearchLoading');
            if (searchLoading) searchLoading.classList.add('d-none');
            
            if (result.success && Array.isArray(result.products) && result.products.length > 0) {
              allLoadedProducts = result.products;
              displayProductSearchResults(result.products);
              notifications.success(`Załadowano ${result.products.length} produktów`, "Możesz wybierać produkty");
            } else {
              const noResults = document.getElementById('productSearchNoResults');
              if (noResults) {
                noResults.classList.remove('d-none');
                noResults.innerText = "Brak dostępnych produktów dla wybranego cennika i kategorii.";
              }
            }
          })
          .withFailureHandler(function(error) {
            const searchLoading = document.getElementById('productSearchLoading');
            if (searchLoading) searchLoading.classList.add('d-none');
            notifications.error("Błąd ładowania produktów: " + (error.message || "Nieznany błąd"), "Błąd");
          })
          .searchProducts(cennikId, category, '');
      } catch (e) {
        console.error("Błąd podczas wyszukiwania produktów:", e);
        notifications.error("Wystąpił nieoczekiwany błąd podczas wyszukiwania produktów.");
      }
    }
    
    // Funkcja wyświetlająca wyniki wyszukiwania produktów
    function displayProductSearchResults(products) {
      try {
        const resultsContainer = document.getElementById('productSearchResults');
        if (!resultsContainer) return;
        
        resultsContainer.innerHTML = '';
        
        // Licznik produktów na górze wyników
        const countInfo = document.createElement('div');
        countInfo.className = 'alert alert-info mb-3 col-12';
        countInfo.innerHTML = `<strong>Załadowano ${products.length} produktów</strong>`;
        resultsContainer.appendChild(countInfo);
        
        // Wyświetlanie kart produktów w trzech kafelkach
        products.forEach(function(product) {
          // Konwersja na miniaturę
          let imageUrl = convertToThumbnail(product['Link do obrazu']);
          
          const productCard = document.createElement('div');
          productCard.className = 'col-md-4 mb-4'; // Ustawione na col-md-4 dla 3 kafelków w rzędzie
          productCard.innerHTML = `
            <div class="card h-100 product-card">
              <div class="row g-0">
                <div class="col-md-4 d-flex align-items-center justify-content-center p-2">
                  <img src="${imageUrl}" 
                       class="img-fluid rounded" alt="${product['Nazwa części'] || 'Produkt'}"
                       style="max-height: 150px;" 
                       onerror="this.src='https://placeholder.pics/svg/150/DEDEDE/555555/Brak+zdjecia'">
                </div>
                <div class="col-md-8">
                  <div class="card-body">
                    <h5 class="card-title">${product['Nazwa części'] || 'Brak nazwy'}</h5>
                    <p class="card-text"><strong>Kod:</strong> ${product.Kod || 'Brak kodu'}</p>
                    <p class="card-text small text-muted mb-1"><strong>Kategoria naprawy:</strong> Cargo</p>
                    <p class="card-text small text-muted mb-2"><strong>Kategoria produktu:</strong> Drivetrain</p>
                    <button class="btn btn-primary select-product-btn">Wybierz produkt</button>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // Dodanie obsługi kliknięcia przycisku
          productCard.querySelector('.select-product-btn').addEventListener('click', function() {
            if (modals.productSearch) modals.productSearch.hide();
            showProductDetail(product, imageUrl);
          });
          
          resultsContainer.appendChild(productCard);
        });
      } catch (e) {
        console.error("Błąd podczas wyświetlania wyników wyszukiwania produktów:", e);
        notifications.error("Wystąpił błąd podczas wyświetlania wyników wyszukiwania produktów.");
      }
    }

    function showProductDetail(product, imageUrl) {
      try {
        console.log("Pokazywanie szczegółów produktu:", product);
        selectedProduct = product;
        
        document.getElementById('productDetailTitle').innerText = product['Nazwa części'] || 'Szczegóły produktu';
        document.getElementById('productDetailName').innerText = product['Nazwa części'] || 'Brak nazwy';
        document.getElementById('productDetailCode').innerText = `Kod: ${product.Kod || 'Brak kodu'}`;
        document.getElementById('productDetailCategory').innerText = `Kategoria: ${product['Kategoria naprawy'] || 'Brak kategorii'}`;
        
        const productImage = document.getElementById('productDetailImage');
        if (productImage) {
          const thumbnailUrl = convertToThumbnail(product['Link do obrazu']);
          console.log("URL miniatury produktu:", thumbnailUrl);
          productImage.src = thumbnailUrl;
          productImage.onerror = function() {
            console.log("Błąd ładowania obrazu produktu, ustawiam placeholder");
            this.src = 'https://placeholder.pics/svg/200/DEDEDE/555555/Brak+zdjecia';
          };
        }
        
        document.getElementById('productQuantity').value = 1;
        
        // Ustawienie handlera dla przycisku dodawania do zamówienia
        const addButton = document.getElementById('addToOrderBtn');
        if (addButton) {
          // Usunięcie starych handlerów
          const newButton = addButton.cloneNode(true);
          addButton.parentNode.replaceChild(newButton, addButton);
          
          // Dodanie nowego handlera
          newButton.addEventListener('click', function() {
            addToOrder();
          });
        }
        
        modals.productDetail.show();
      } catch (e) {
        console.error("Błąd podczas wyświetlania szczegółów produktu:", e);
        notifications.error("Wystąpił błąd podczas wyświetlania szczegółów produktu: " + e.message);
      }
    }

    // Naprawiona funkcja addToOrder z pełnym debugowaniem
    function addToOrder() {
      try {
        console.log("Rozpoczęcie funkcji addToOrder, selectedProduct:", selectedProduct);
        
        if (!selectedProduct) {
          notifications.error("Brak wybranego produktu", "Błąd dodawania");
          return;
        }
      
        const quantityInput = document.getElementById('productQuantity');
        if (!quantityInput) {
          console.error("Nie znaleziono pola quantityInput");
          notifications.error("Nie można znaleźć pola ilości produktu", "Błąd formularza");
          return;
        }
        
        const quantity = parseInt(quantityInput.value);
        console.log("Wybrana ilość produktu:", quantity);
        
        if (isNaN(quantity) || quantity < 1) {
          notifications.warning("Wprowadź poprawną ilość!", "Niepoprawna wartość");
          return;
        }
        
        const serwis = document.getElementById('service').value;
        const category = document.getElementById('repairCategory').value;
        const operator = document.getElementById('operator').value;
        const department = document.getElementById('department').value;
        
        console.log("Podstawowe dane zamówienia:", {serwis, category, operator, department});
        
        if (!serwis || !category || !operator || !department) {
          notifications.warning("Uzupełnij wszystkie dane podstawowe", "Brakujące dane");
          return;
        }
      
        // Sprawdź czy produkt już jest w zamówieniu
        const codeAsString = selectedProduct.Kod ? selectedProduct.Kod.toString() : '';
        console.log("Szukanie produktu w zamówieniu, kod:", codeAsString);
        
        const existingItemIndex = orderItems.findIndex(item => 
          item.code === codeAsString && 
          item.category === category && 
          item.operator === operator &&
          item.department === department
        );
        
        console.log("Czy produkt istnieje w zamówieniu:", existingItemIndex !== -1);
        
        if (existingItemIndex !== -1) {
          // Aktualizujemy ilość
          orderItems[existingItemIndex].quantity += quantity;
          console.log("Zaktualizowano ilość w istniejącym produkcie:", orderItems[existingItemIndex]);
          notifications.info(`Zwiększono ilość produktu ${selectedProduct['Nazwa części']}`, "Zaktualizowano produkt");
        } else {
          // Dodajemy nowy produkt z konwersją miniatury
          let imageUrl = convertToThumbnail(selectedProduct['Link do obrazu']);
          
          // Zapisujemy aktualnie wybrane wartości dla tego produktu z konwersją Kod na string
          const newItem = {
            code: codeAsString,
            name: selectedProduct['Nazwa części'] || 'Produkt bez nazwy',
            category: category,
            operator: operator,
            department: department,
            quantity: quantity,
            image: imageUrl
          };
          
          console.log("Dodawanie nowego produktu do zamówienia:", newItem);
          orderItems.push(newItem);
          notifications.success(`Dodano produkt: ${newItem.name}`, "Dodano do zamówienia");
        }
        
        console.log("Aktualna lista produktów w zamówieniu:", orderItems);
        modals.productDetail.hide();
        updateOrderTable();
        document.getElementById('submitOrderBtn').disabled = false;
      } catch (e) {
        console.error("Błąd podczas dodawania produktu do zamówienia:", e, "Produkt:", selectedProduct);
        notifications.error(`Wystąpił błąd podczas dodawania produktu do zamówienia: ${e.message}`, "Błąd krytyczny");
      }
    }

    // Obsługa zmiany serwisu
    function handleServiceChange() {
      console.log("Wywołano handleServiceChange");
      const serwis = document.getElementById('service').value;
      
      if (!serwis) {
        resetSelect('repairCategory', 'Wybierz kategorię');
        resetSelect('operator', 'Wybierz operatora');
        resetSelect('department', 'Wybierz oddział');
        return;
      }
      
      showLoading("Wczytywanie kategorii napraw...");
      
      // Debugowanie
      console.log("Wysyłam zapytanie o kategorie napraw dla serwisu:", serwis);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log("Otrzymano odpowiedź dla kategorii:", result);
          hideLoading();
          
          if (result.success) {
            const select = document.getElementById('repairCategory');
            select.innerHTML = '<option value="">Wybierz kategorię</option>';
            
            result.categories.forEach(category => {
              const option = document.createElement('option');
              option.value = category;
              option.textContent = category;
              select.appendChild(option);
            });
            
            select.disabled = false;
            
            // Reinicjalizacja Select2 po dodaniu opcji
            try {
              $('#repairCategory').select2('destroy');
            } catch(e) {
              console.log('Brak poprzedniej inicjalizacji repairCategory');
            }
            $('#repairCategory').select2({
              width: '100%',
              placeholder: "Wybierz kategorię",
              allowClear: true
            });
          } else {
            showError(result.message);
          }
        })
        .withFailureHandler(function(error) {
          console.error("Błąd pobierania kategorii:", error);
          hideLoading();
          showError("Błąd pobierania kategorii: " + (error.message || "Nieznany błąd"));
        })
        .getRepairCategories(serwis);
    }
    
    // Obsługa zmiany kategorii naprawy
    function handleCategoryChange() {
      console.log("Wywołano handleCategoryChange");
      const serwis = document.getElementById('service').value;
      const category = document.getElementById('repairCategory').value;
      
      if (!category) {
        resetSelect('operator', 'Wybierz operatora');
        resetSelect('department', 'Wybierz oddział');
        return;
      }
      
      showLoading("Wczytywanie operatorów...");
      
      // Debugowanie
      console.log("Wysyłam zapytanie o operatorów dla serwisu:", serwis, "i kategorii:", category);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log("Otrzymano odpowiedź dla operatorów:", result);
          hideLoading();
          
          if (result.success) {
            const select = document.getElementById('operator');
            select.innerHTML = '<option value="">Wybierz operatora</option>';
            
            result.operators.forEach(operator => {
              const option = document.createElement('option');
              option.value = operator;
              option.textContent = operator;
              select.appendChild(option);
            });
            
            select.disabled = false;
            
            // Reinicjalizacja Select2 po dodaniu opcji
            try {
              $('#operator').select2('destroy');
            } catch(e) {
              console.warn("Błąd podczas reinicjalizacji Select2 dla operatora:", e);
            }
            $('#operator').select2({
              width: '100%',
              placeholder: "Wybierz operatora",
              allowClear: true
            });            $('#operator').prop('disabled', false);
            
            // Sprawdź i zaktualizuj stan przycisków typu serwisu
            updateServiceTypeButtonsState();
            
            notifications.info("Wybrano kategorię: " + category, "Kategoria naprawy");
          } else {
            showError(result.message);
          }
        })
        .withFailureHandler(function(error) {
          console.error("Błąd pobierania operatorów:", error);
          hideLoading();
          showError("Błąd pobierania operatorów: " + (error.message || "Nieznany błąd"));
        })
        .getOperators(serwis, category);
    }

    // Obsługa zmiany operatora
    function handleOperatorChange() {
      console.log("Wywołano handleOperatorChange");
      const serwis = document.getElementById('service').value;
      const category = document.getElementById('repairCategory').value;
      const operator = document.getElementById('operator').value;
      
      if (!operator) {
        resetSelect('department', 'Wybierz oddział');
        return;
      }
      
      showLoading("Wczytywanie oddziałów...");
      
      // Debugowanie
      console.log("Wysyłam zapytanie o oddziały dla serwisu:", serwis, "kategorii:", category, "i operatora:", operator);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log("Otrzymano odpowiedź dla oddziałów:", result);
          hideLoading();
          
          if (result.success) {
            const select = document.getElementById('department');
            select.innerHTML = '<option value="">Wybierz oddział</option>';
            
            result.departments.forEach(department => {
              const option = document.createElement('option');
              option.value = department;
              option.textContent = department;
              select.appendChild(option);
            });
            
            select.disabled = false;
            
            // Reinicjalizacja Select2 po dodaniu opcji
            try {
              $('#department').select2('destroy');
            } catch(e) {
              console.log('Brak poprzedniej inicjalizacji department');
            }
            $('#department').select2({
              width: '100%',
              placeholder: "Wybierz oddział",
              allowClear: true
            });
          } else {
            showError(result.message);
          }
        })
        .withFailureHandler(function(error) {
          console.error("Błąd pobierania oddziałów:", error);
          hideLoading();
          showError("Błąd pobierania oddziałów: " + (error.message || "Nieznany błąd"));
        })
        .getDepartments(serwis, category, operator);
    }

    // Funkcja do ładowania numerów ram przy zmianie oddziału
    function handleDepartmentChange() {
      const department = document.getElementById('department').value;
      
      if (!department) return;
        // Najpierw pobierz ID cennika
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            cennikId = result.cennikId;
            console.log("Pobrano ID cennika:", cennikId);
            
            // Sprawdź i zaktualizuj stan przycisków typu serwisu
            updateServiceTypeButtonsState();
            
            // Po pobraniu ID cennika, załaduj numery ram
            loadFrameNumbers(department);
          } else {
            notifications.error(result.message || "Błąd pobierania ID cennika");
          }
        })
        .withFailureHandler(function(error) {
          notifications.error("Błąd pobierania ID cennika: " + (error.message || "Nieznany błąd"));
        })
        .getPriceListId(
          document.getElementById('service').value,
          document.getElementById('repairCategory').value,
          document.getElementById('operator').value,
          department
        );
    }

    // Funkcja do ładowania numerów ram dla wybranego oddziału
    function loadFrameNumbers(department) {
      if (!department) return;
      
      // Czyszczenie listy numerów ram za każdym razem gdy zmienia się oddział
      const select = document.getElementById('frameNumberSelect');
      select.innerHTML = '<option value="">Wybierz numer ramy</option>';
      
      // Pokaż komunikat ładowania
      showLoading("Wczytywanie numerów ram...");
      
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          
          // Niezależnie od wyniku, dodaj opcję "Inny" by zawsze można było dodać nowy numer
          const otherOption = document.createElement('option');
          otherOption.value = "OTHER";
          otherOption.textContent = "Inne - dodaj nowy numer ramy";
          otherOption.className = "bg-success text-white";
          otherOption.style.backgroundColor = "#198754"; // zielony kolor tła
          otherOption.style.color = "white"; // biały kolor tekstu
          select.appendChild(otherOption);
          
          // Włącz select zawsze, nawet gdy brak wyników
          select.disabled = false;

          if (result.success && Array.isArray(result.frames) && result.frames.length > 0) {
            // Dodaj opcje z ramami przed opcją "Inny"
            // Usuwamy ostatnią opcję (Inny), dodajemy nowe opcje, i ponownie dodajemy opcję Inny na końcu
            select.removeChild(select.lastChild);
            
            result.frames.forEach(frame => {
              const option = document.createElement('option');
              option.value = frame.value;
              
              // Parsuj wartość, aby wyodrębnić numer serialowy
              try {
                const frameData = JSON.parse(frame.value);
                option.textContent = frameData.serialNumber || 'Brak numeru';
              } catch (e) {
                // W przypadku błędu parsowania używamy text
                option.textContent = frame.text || 'Brak numeru';
              }
              
              select.appendChild(option);
            });
            
            // Dodaj ponownie opcję "Inny" na końcu listy
            select.appendChild(otherOption);
            
            notifications.success(`Załadowano ${result.frames.length} numerów ram`, "Dane ram pobrane");
          } else {
            // Dodaj informację w select gdy nie ma ram
            const noFramesOption = document.createElement('option');
            noFramesOption.value = "";
            noFramesOption.textContent = "Brak przypisanych ram do tego oddziału";
            noFramesOption.disabled = true;
            // Wstaw tę opcję przed opcją "Inny"
            select.insertBefore(noFramesOption, select.lastChild);
            
            notifications.warning("Nie znaleziono rowerów w wybranym oddziale", "Brak numerów ram");
          }
          
          // Dodaj obsługę zmiany numeru ramy
          select.onchange = handleFrameNumberChange;
        })
        .withFailureHandler(function(error) {
          hideLoading();
          notifications.error("Błąd wyszukiwania ram: " + (error.message || "Nieznany błąd"), "Błąd");
          
          // Mimo błędu, dodaj opcję "Inny" aby umożliwić dodanie nowego numeru
          const otherOption = document.createElement('option');
          otherOption.value = "OTHER";
          otherOption.textContent = "Inne - dodaj nowy numer ramy";
          otherOption.className = "bg-success text-white";
          otherOption.style.backgroundColor = "#198754";
          otherOption.style.color = "white";
          select.appendChild(otherOption);
          
          // Włącz select mimo błędu
          select.disabled = false;
          select.onchange = handleFrameNumberChange;
        })
        .searchFrameNumbers(department);
    }

    // Obsługa zmiany numeru ramy
    function handleFrameNumberChange() {
      const select = document.getElementById('frameNumberSelect');
      const value = select.value;
      
      if (!value) {
        document.getElementById('lastInspection').value = '';
        return;
      }
      
      if (value === "OTHER") {
        const departmentName = document.getElementById('department').value;
        document.getElementById('departmentNameDisplay').textContent = departmentName || "Nieznany oddział";
        modals.newFrameNumber.show();
        return;
      }
      
      try {
        const frameData = JSON.parse(value);
        
        // Jeśli jest data ostatniego przeglądu, ustaw ją
        if (frameData.lastInspection) {
          const lastInspection = new Date(frameData.lastInspection);
          const formattedDate = lastInspection.toISOString().split('T')[0]; // Format YYYY-MM-DD
          document.getElementById('lastInspection').value = formattedDate;
        } else {
          document.getElementById('lastInspection').value = '';
        }
      } catch (e) {
        console.error("Błąd podczas parsowania danych ramy:", e);
        document.getElementById('lastInspection').value = '';
      }
    }

    // Funkcja do obsługi przycisku zapisywania nowego numeru ramy
    function handleNewFrameNumberSave() {
      // Pobierz wartości z formularza
      const newFrameNumber = document.getElementById('newFrameNumber').value.trim();
      const department = document.getElementById('department').value;
      
      // Sprawdź czy numer ramy został wprowadzony
      if (!newFrameNumber) {
        notifications.warning("Numer ramy jest wymagany", "Brakujące dane");
        return;
      }
      
      // Sprawdź czy oddział został wybrany
      if (!department) {
        notifications.warning("Wybierz oddział zanim dodasz nowy numer ramy", "Brakujące dane");
        return;
      }
      
      // Pokaż komunikat ładowania
      showLoading("Zapisywanie nowego numeru ramy...");
      
      // Przygotuj dane do wysłania
      const frameData = {
        serialNumber: newFrameNumber,
        department: department
      };
      
      // Wywołaj funkcję serwera do zapisania numeru ramy
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          
          if (result.success) {
            // Zamknij modal
            modals.newFrameNumber.hide();
            
            // Wyświetl powiadomienie o sukcesie
            notifications.success(result.message, "Numer ramy dodany");
            
            // Odświeżenie listy numerów ram
            loadFrameNumbers(department);
          } else {
            notifications.error(result.message, "Błąd");
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          notifications.error("Błąd podczas zapisywania numeru ramy: " + (error.message || "Nieznany błąd"), "Błąd");
        })
        .saveNewFrameNumber(frameData);
    }    // Funkcja do wyboru typu serwisu
    function selectServiceType(type, retryCount = 0) {
      console.log("Próba wyboru typu serwisu:", type);
      
      // Sprawdź czy wszystkie wymagane dane są załadowane
      if (!checkDataLoadingState()) {
        notifications.warning(
          "Przed wyborem typu serwisu musisz uzupełnić wszystkie dane podstawowe (serwis, kategoria naprawy, operator, oddział)",
          "Brak wymaganych danych"
        );
        return;
      }
      
      console.log("Wybrano typ serwisu:", type);
      // Zaznacz odpowiedni radiobutton
      if (type === 'Podstawowy') {
        document.getElementById('serviceTypeBasic').checked = true;
        document.getElementById('serviceTypeAdvanced').checked = false;
      } else if (type === 'Eksploatacyjny') {
        document.getElementById('serviceTypeBasic').checked = false;
        document.getElementById('serviceTypeAdvanced').checked = true;
      }
      // Podświetl wybrany kafelek
      const cards = document.querySelectorAll('.service-type-card label');
      cards.forEach(card => {
        if (card.innerText.includes(type)) {
          card.classList.add('selected-service-type');
        } else {
          card.classList.remove('selected-service-type');
        }
      });
      
      // Najpierw sprawdź, czy mamy już załadowane usługi, jeśli nie - załaduj je najpierw
      if (!Array.isArray(allLoadedServices) || allLoadedServices.length === 0) {
        // Jeśli nie mamy jeszcze usług, załaduj je
        if (!cennikId) {
          notifications.warning("Najpierw wybierz wszystkie dane podstawowe", "Nie można załadować usług");
          return;
        }
        
        notifications.info("Ładowanie usług dla wybranego typu serwisu...", "Proszę czekać");
        
        // Ładujemy usługi i po załadowaniu ponownie wywołujemy tę funkcję
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success && Array.isArray(result.services) && result.services.length > 0) {
              allLoadedServices = result.services;
              // Ponownie wywołaj selectServiceType, ale bez dodatkowego ładowania
              selectServiceType(type, 0);
              notifications.success(`Załadowano ${result.services.length} usług`, "Możesz wybierać usługi");
            } else {
              notifications.error('Nie można pobrać listy usług z cennika. Spróbuj ponownie.');
            }
          })
          .withFailureHandler(function(error) {
            notifications.error("Błąd ładowania usług: " + (error.message || "Nieznany błąd"), "Błąd");
          })
          .searchServices(cennikId, document.getElementById('repairCategory').value, '');
        return;
      }      // Teraz mamy już załadowane usługi, więc możemy dodać/usunąć Serwis podstawowy
      // Usuwanie wszystkich usług "Serwis podstawowy" jeśli istnieją (czyszczenie przed dodaniem nowej)
      serviceItems = serviceItems.filter(item => item.name !== 'Serwis podstawowy');
        if (type === 'Podstawowy') {
        // Szukaj usługi "Serwis podstawowy" w allLoadedServices
        const podstawowy = allLoadedServices.find(s => (s['Nazwa usługi'] || s.name) === 'Serwis podstawowy');
        if (podstawowy) {
          // Pobierz dane podstawowe do porównania
          const category = document.getElementById('repairCategory').value;
          const operator = document.getElementById('operator').value;
          const department = document.getElementById('department').value;
          const codeAsString = podstawowy.Kod ? podstawowy.Kod.toString() : '';
          
          // Sprawdź czy nie ma już tej usługi na liście (używając tej samej logiki co addServiceToOrder)
          const existingItemIndex = serviceItems.findIndex(item => 
            item.code === codeAsString && 
            item.category === category && 
            item.operator === operator &&
            item.department === department
          );
          
          if (existingItemIndex === -1) {
            serviceItems.push({
              code: codeAsString,
              name: podstawowy['Nazwa usługi'] || podstawowy.name || 'Serwis podstawowy',
              category: category,
              operator: operator,
              department: department,
              price: typeof podstawowy.Cena === 'number' ? podstawowy.Cena : (parseFloat(podstawowy.Cena) || 0),
              quantity: 1,
              isCustom: false
            });
            notifications.success('Dodano usługę: Serwis podstawowy', 'Automatycznie dodano usługę');
            
            // Aktywuj przycisk "Zapisz raport" po dodaniu usługi Serwis podstawowy
            document.getElementById('submitOrderBtn').disabled = false;
          } else {
            console.log('Usługa "Serwis podstawowy" już istnieje w zamówieniu');
          }
        } else {
          notifications.error('Brak usługi "Serwis podstawowy" w cenniku!', 'Brak usługi');
        }
      }
      updateServiceTable();
      notifications.info(`Wybrano typ serwisu: ${type}`, "Typ serwisu");
    }

    // Funkcja do filtrowania produktów - poprawiona obsługa Kod jako liczby
    function filterDisplayedProducts(searchTerm) {
      if (!searchTerm || !allLoadedProducts || allLoadedProducts.length === 0) return;
      
      console.log("Filtrowanie produktów wg:", searchTerm);
      const searchTermLower = searchTerm.toLowerCase();
      
      const filteredProducts = allLoadedProducts.filter(product => {
        try {
          const nazwa = (product['Nazwa części'] || '').toString().toLowerCase();
          // Konwersja Kod na string aby uniknąć błędu toLowerCase na liczbach
          const kod = (product.Kod !== undefined && product.Kod !== null) ? product.Kod.toString().toLowerCase() : '';
          return nazwa.includes(searchTermLower) || kod.includes(searchTermLower);
        } catch (e) {
          console.error("Błąd podczas filtrowania produktu:", e, product);
          return false;
        }
      });
      
      const resultsContainer = document.getElementById('productSearchResults');
      const noResults = document.getElementById('productSearchNoResults');
      
      if (filteredProducts.length > 0) {
        displayProductSearchResults(filteredProducts);
        if (noResults) noResults.classList.add('d-none');
      } else {
        if (resultsContainer) resultsContainer.innerHTML = '';
        if (noResults) {
          noResults.innerText = `Nie znaleziono produktów zawierających "${searchTerm}"`;
          noResults.classList.remove('d-none');
        }
      }
    }

    // Funkcja resetująca filtrowanie produktów
    function resetProductsFilter() {
      if (!allLoadedProducts) return;
      
      displayProductSearchResults(allLoadedProducts);
      const noResults = document.getElementById('productSearchNoResults');
      if (noResults) noResults.classList.add('d-none');
    }

    // Funkcja do wyszukiwania produktów w modalu
    function searchProductsInModal(searchTerm) {
      if (!searchTerm || !cennikId) return;
      
      const searchLoading = document.getElementById('productSearchLoading');
      const resultsContainer = document.getElementById('productSearchResults');
      const noResults = document.getElementById('productSearchNoResults');
      
      if (searchLoading) searchLoading.classList.remove('d-none');
      if (resultsContainer) resultsContainer.innerHTML = '';
      if (noResults) noResults.classList.add('d-none');
      
      const category = document.getElementById('repairCategory').value;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (searchLoading) searchLoading.classList.add('d-none');
          
          if (result.success && Array.isArray(result.products) && result.products.length > 0) {
            displayProductSearchResults(result.products);
          } else {
            if (noResults) {
              noResults.innerText = `Nie znaleziono produktów zawierających "${searchTerm}"`;
              noResults.classList.remove('d-none');
            }
          }
        })
        .withFailureHandler(function(error) {
          if (searchLoading) searchLoading.classList.add('d-none');
          notifications.error("Błąd wyszukiwania: " + (error.message || "Nieznany błąd"));
        })
        .searchProducts(cennikId, category, searchTerm);
    }

    // Funkcja do filtrowania usług
    function filterDisplayedServices(searchTerm) {
      if (!searchTerm || !allLoadedServices || allLoadedServices.length === 0) return;
      
      console.log("Filtrowanie usług wg:", searchTerm);
      const searchTermLower = searchTerm.toLowerCase();
      
      const filteredServices = allLoadedServices.filter(service => {
        try {
          const nazwa = (service['Nazwa usługi'] || '').toString().toLowerCase();
          const kod = (service.Kod !== undefined && service.Kod !== null) ? service.Kod.toString().toLowerCase() : '';
          return nazwa.includes(searchTermLower) || kod.includes(searchTermLower);
        } catch (e) {
          console.error("Błąd podczas filtrowania usługi:", e, service);
          return false;
        }
      });
      
      const resultsContainer = document.getElementById('serviceSearchResults');
      const noResults = document.getElementById('serviceSearchNoResults');
      
      if (filteredServices.length > 0) {
        displayServiceSearchResults(filteredServices);
        if (noResults) noResults.classList.add('d-none');
      } else {
        if (resultsContainer) resultsContainer.innerHTML = '';
        if (noResults) {
          noResults.innerText = `Nie znaleziono usług zawierających "${searchTerm}"`;
          noResults.classList.remove('d-none');
        }
      }
    }

    // Funkcja resetująca filtrowanie usług
    function resetServicesFilter() {
      if (!allLoadedServices) return;
      
      displayServiceSearchResults(allLoadedServices);
      const noResults = document.getElementById('serviceSearchNoResults');
      if (noResults) noResults.classList.add('d-none');
    }

    // Funkcja do wyszukiwania usług w modalu
    function searchServicesInModal(searchTerm) {
      if (!searchTerm || !cennikId) return;
      
      const searchLoading = document.getElementById('serviceSearchLoading');
      const resultsContainer = document.getElementById('serviceSearchResults');
      const noResults = document.getElementById('serviceSearchNoResults');
      
      if (searchLoading) searchLoading.classList.remove('d-none');
      if (resultsContainer) resultsContainer.innerHTML = '';
      if (noResults) noResults.classList.add('d-none');
      
      const category = document.getElementById('repairCategory').value;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (searchLoading) searchLoading.classList.add('d-none');
          
          if (result.success && Array.isArray(result.services) && result.services.length > 0) {
            displayServiceSearchResults(result.services);
          } else {
            if (noResults) {
              noResults.innerText = `Nie znaleziono usług zawierających "${searchTerm}"`;
              noResults.classList.remove('d-none');
            }
          }
        })
        .withFailureHandler(function(error) {
          if (searchLoading) searchLoading.classList.add('d-none');
          notifications.error("Błąd wyszukiwania: " + (error.message || "Nieznany błąd"));
        })
        .searchServices(cennikId, category, searchTerm);
    }

    // Funkcja do aktualizacji ilości produktu w zamówieniu
    function updateItemQuantity(index, newQuantity) {
      newQuantity = parseInt(newQuantity);
      
      if (isNaN(newQuantity) || newQuantity < 1) {
        notifications.warning("Ilość musi być liczbą większą od zera", "Niepoprawna wartość");
        updateOrderTable(); // Przywróć poprzednią wartość
        return;
      }
      
      if (index >= 0 && index < orderItems.length) {
        orderItems[index].quantity = newQuantity;
        updateOrderTable();
        notifications.info(`Zaktualizowano ilość: ${orderItems[index].name} - ${newQuantity} szt.`);
      }
    }
    
    // Funkcja do usuwania części z zamówienia
    function removeOrderItem(index) {
      if (index >= 0 && index < orderItems.length) {
        const removedItem = orderItems[index];
        orderItems.splice(index, 1);
        updateOrderTable();
        notifications.info(`Usunięto część: ${removedItem.name}`);
        
        // Jeśli nie ma już części i usług, wyłącz przycisk wysyłki
        if (orderItems.length === 0 && serviceItems.length === 0) {
          document.getElementById('submitOrderBtn').disabled = true;
        }
      }
    }

    // Funkcja do otwierania modalu wyszukiwania produktów
    function openProductSearchModal() {
      const searchInput = document.getElementById('productSearchInput');
      const searchResults = document.getElementById('productSearchResults');
      const noResults = document.getElementById('productSearchNoResults');
      const loading = document.getElementById('productSearchLoading');
      
      if (searchInput) searchInput.value = '';
      if (searchResults) searchResults.innerHTML = '';
      if (noResults) noResults.classList.add('d-none');
      
      if (loading) {
        loading.classList.remove('d-none');
        const loadingText = loading.querySelector('p');
        if (loadingText) loadingText.innerText = 'Trwa ładowanie wszystkich produktów...';
      }
      
      if (modals.productSearch) modals.productSearch.show();
      
      // Automatycznie załaduj wszystkie produkty po otwarciu modalu
      loadAllProducts();
      loadProductCategories();
    }

    // Funkcja ładująca wszystkie usługi dla wybranej kategorii
    function loadAllServices() {
      try {
        if (!cennikId) {
          const searchLoading = document.getElementById('serviceSearchLoading');
          if (searchLoading) searchLoading.classList.add('d-none');
          notifications.warning("Najpierw wybierz wszystkie dane podstawowe", "Nie można załadować usług");
          return;
        }

        const resultsContainer = document.getElementById('serviceSearchResults');
        if (resultsContainer) resultsContainer.innerHTML = '';
        
        const category = document.getElementById('repairCategory').value;
        
        google.script.run
          .withSuccessHandler(function(result) {
            const searchLoading = document.getElementById('serviceSearchLoading');
            if (searchLoading) searchLoading.classList.add('d-none');
            
            if (result.success && Array.isArray(result.services) && result.services.length > 0) {
              allLoadedServices = result.services;
              displayServiceSearchResults(result.services);
              notifications.success(`Załadowano ${result.services.length} usług`, "Możesz wybierać usługi");
            } else {
              const noResults = document.getElementById('serviceSearchNoResults');
              if (noResults) {
                noResults.classList.remove('d-none');
                noResults.innerText = "Brak dostępnych usług dla wybranego cennika i kategorii.";
              }
            }
          })
          .withFailureHandler(function(error) {
            const searchLoading = document.getElementById('serviceSearchLoading');
            if (searchLoading) searchLoading.classList.add('d-none');
            notifications.error("Błąd ładowania usług: " + (error.message || "Nieznany błąd"), "Błąd");
          })
          .searchServices(cennikId, category, '');
      } catch (e) {
        console.error("Błąd podczas wyszukiwania usług:", e);
        notifications.error("Wystąpił nieoczekiwany błąd podczas wyszukiwania usług.");
      }
    }

    // Funkcja wyświetlająca wyniki wyszukiwania usług jako listę rozwijaną
    function displayServiceSearchResults(services) {
      try {
        const resultsContainer = document.getElementById('serviceSearchResults');
        if (!resultsContainer) return;
        
        resultsContainer.innerHTML = '';
        
        // Licznik usług na górze wyników
        const countInfo = document.createElement('div');
        countInfo.className = 'alert alert-info mb-3 col-12';
        countInfo.innerHTML = `<strong>Załadowano ${services.length} usług</strong>`;
        resultsContainer.appendChild(countInfo);
        
        // Kontener dla listy rozwijananej usług
        const listContainer = document.createElement('div');
        listContainer.className = 'list-group w-100';
        
        // Wyświetlanie usług jako elementy listy rozwijananej
        services.forEach(function(service) {
          const serviceItem = document.createElement('a');
          serviceItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
          serviceItem.href = '#';
          serviceItem.innerHTML = `
            <div>
              <h5 class="mb-1">${service['Nazwa usługi'] || 'Brak nazwy'}</h5>
              <small class="text-muted">Kod: ${service.Kod || 'Brak kodu'} | Kategoria: ${service['Kategoria naprawy'] || 'Brak kategorii'}</small>
            </div>
            <div>
              <span class="badge bg-primary rounded-pill">${service.Cena ? service.Cena.toFixed(2) + ' zł' : 'Cena do ustalenia'}</span>
            </div>
          `;
          
          // Dodanie obsługi kliknięcia
          serviceItem.addEventListener('click', function(e) {
            e.preventDefault();
            if (modals.serviceSearch) modals.serviceSearch.hide();
            showServiceDetail(service);
          });
          
          listContainer.appendChild(serviceItem);
        });
        
        resultsContainer.appendChild(listContainer);
        
        // Dodanie opcji "Inna usługa" w kolorze zielonym na końcu listy
        const customServiceItem = document.createElement('a');
        customServiceItem.className = 'list-group-item list-group-item-action bg-success text-white d-flex justify-content-between align-items-center mt-3';
        customServiceItem.href = '#';
        customServiceItem.innerHTML = `
          <div>
            <h5 class="mb-1">Inna usługa</h5>
            <small>Dodaj niestandardową usługę nie znajdującą się na liście</small>
          </div>
          <div>
            <i class="bi bi-plus-circle-fill fs-4"></i>
          </div>
        `;
        
        // Dodanie obsługi kliknięcia dla niestandardowej usługi
        customServiceItem.addEventListener('click', function(e) {
          e.preventDefault();
          if (modals.serviceSearch) modals.serviceSearch.hide();
          openCustomServiceModal();
        });
        
        listContainer.appendChild(customServiceItem);
        
      } catch (e) {
        console.error("Błąd podczas wyświetlania wyników wyszukiwania usług:", e);
        notifications.error("Wystąpił błąd podczas wyświetlania wyników wyszukiwania usług.");
      }
    }

    // Funkcja pokazująca szczegóły usługi z obsługą blokowania/odblokowywania pola ceny
    function showServiceDetail(service) {
      try {
        console.log("Pokazywanie szczegółów usługi:", service);
        selectedService = service;
        
        document.getElementById('serviceDetailTitle').innerText = service['Nazwa usługi'] || 'Szczegóły usługi';
        document.getElementById('serviceDetailName').innerText = service['Nazwa usługi'] || 'Brak nazwy';
        document.getElementById('serviceDetailCode').innerText = `Kod: ${service.Kod || 'Brak kodu'}`;
        document.getElementById('serviceDetailCategory').innerText = `Kategoria: ${service['Kategoria naprawy'] || 'Brak kategorii'}`;
        
        const servicePriceInput = document.getElementById('servicePrice');
        if (servicePriceInput) {
          // Ustawienie wartości ceny
          servicePriceInput.value = service.Cena ? service.Cena.toFixed(2) : '0.00';
          
          // Blokowanie/odblokowywanie pola ceny w zależności od tego, czy usługa ma cenę
          if (service.Cena) {
            servicePriceInput.readOnly = true;
            servicePriceInput.classList.add('bg-light');
          } else {
            servicePriceInput.readOnly = false;
            servicePriceInput.classList.remove('bg-light');
          }
        }
        
        document.getElementById('serviceQuantity').value = 1;
        
        // Ustawienie handlera dla przycisku dodawania usługi
        const addButton = document.getElementById('addServiceToOrderBtn');
        if (addButton) {
          // Usunięcie starych handlerów
          const newButton = addButton.cloneNode(true);
          addButton.parentNode.replaceChild(newButton, addButton);
          
          // Dodanie nowego handlera
          newButton.addEventListener('click', function() {
            addServiceToOrder();
          });
        }
        
        modals.serviceDetail.show();
      } catch (e) {
        console.error("Błąd podczas wyświetlania szczegółów usługi:", e);
        notifications.error("Wystąpił błąd podczas wyświetlania szczegółów usługi: " + e.message);
      }
    }

    // Funkcja do dodawania usługi do zamówienia
    function addServiceToOrder() {
      try {
        console.log("Rozpoczęcie funkcji addServiceToOrder, selectedService:", selectedService);
        
        if (!selectedService) {
          notifications.error("Brak wybranej usługi", "Błąd dodawania");
          return;
        }
      
        const quantityInput = document.getElementById('serviceQuantity');
        const priceInput = document.getElementById('servicePrice');
        
        if (!quantityInput || !priceInput) {
          console.error("Nie znaleziono pól serviceQuantity lub servicePrice");
          notifications.error("Nie można znaleźć pól ilości lub ceny usługi", "Błąd formularza");
          return;
        }
        
        const quantity = parseInt(quantityInput.value);
        const price = parseFloat(priceInput.value);
        
        console.log("Wybrana ilość usługi:", quantity, "Cena:", price);
        
        if (isNaN(quantity) || quantity < 1) {
          notifications.warning("Wprowadź poprawną ilość!", "Niepoprawna wartość");
          return;
        }
        
        if (isNaN(price) || price < 0) {
          notifications.warning("Wprowadź poprawną cenę!", "Niepoprawna wartość");
          return;
        }
        
        const serwis = document.getElementById('service').value;
        const category = document.getElementById('repairCategory').value;
        const operator = document.getElementById('operator').value;
        const department = document.getElementById('department').value;
        
        console.log("Podstawowe dane zamówienia:", {serwis, category, operator, department});
        
        if (!serwis || !category || !operator || !department) {
          notifications.warning("Uzupełnij wszystkie dane podstawowe", "Brakujące dane");
          return;
        }
      
        // Sprawdź czy usługa już jest w zamówieniu
        const codeAsString = selectedService.Kod ? selectedService.Kod.toString() : '';
        console.log("Szukanie usługi w zamówieniu, kod:", codeAsString);
        
        const existingItemIndex = serviceItems.findIndex(item => 
          item.code === codeAsString && 
          item.category === category && 
          item.operator === operator &&
          item.department === department
        );
        
        console.log("Czy usługa istnieje w zamówieniu:", existingItemIndex !== -1);
        
        if (existingItemIndex !== -1) {
          // Aktualizujemy ilość i cenę
          serviceItems[existingItemIndex].quantity += quantity;
          serviceItems[existingItemIndex].price = price;
          console.log("Zaktualizowano ilość i cenę w istniejącej usłudze:", serviceItems[existingItemIndex]);
          notifications.info(`Zwiększono ilość usługi ${selectedService['Nazwa usługi']} i zaktualizowano cenę`, "Zaktualizowano usługę");
        } else {
          // Dodajemy nową usługę
          const newItem = {
            code: codeAsString,
            name: selectedService['Nazwa usługi'] || 'Usługa bez nazwy',
            category: category,
            operator: operator,
            department: department,
            quantity: quantity,
            price: price,
            isCustom: false
          };
          
          console.log("Dodawanie nowej usługi do zamówienia:", newItem);
          serviceItems.push(newItem);
          notifications.success(`Dodano usługę: ${newItem.name}`, "Dodano do zamówienia");
        }
        
        console.log("Aktualna lista usług w zamówieniu:", serviceItems);
        modals.serviceDetail.hide();
        updateServiceTable();
        document.getElementById('submitOrderBtn').disabled = false;
      } catch (e) {
        console.error("Błąd podczas dodawania usługi do zamówienia:", e, "Usługa:", selectedService);
        notifications.error(`Wystąpił błąd podczas dodawania usługi do zamówienia: ${e.message}`, "Błąd krytyczny");
      }
    }

    // Funkcja otwierająca modal niestandardowej usługi
    function openCustomServiceModal() {
      try {
        console.log("Otwieranie modalu niestandardowej usługi");
        
        // Sprawdzenie wymaganych danych podstawowych
        const serwis = document.getElementById('service').value;
        const category = document.getElementById('repairCategory').value;
        const operator = document.getElementById('operator').value;
        const department = document.getElementById('department').value;
        
        if (!serwis || !category || !operator || !department) {
          notifications.warning("Uzupełnij wszystkie dane podstawowe przed dodaniem niestandardowej usługi", "Brakujące dane");
          return;
        }
        
        // Resetowanie pól formularza
        document.getElementById('customServiceName').value = '';
        document.getElementById('customServiceDescription').value = '';
        document.getElementById('customServicePrice').value = '0.00';
        
        // Pokazanie modalu
        if (modals.customService) {
          modals.customService.show();
        }
      } catch (e) {
        console.error("Błąd podczas otwierania modalu niestandardowej usługi:", e);
        notifications.error("Wystąpił błąd podczas otwierania formularza", "Błąd systemowy");
      }
    }

    // Jednolita, w pełni poprawiona implementacja funkcji addCustomService
    function addCustomService() {
      try {
        console.log("Rozpoczęcie funkcji addCustomService");
        
        // 1. Najpierw sprawdź czy nazwa usługi została wprowadzona
        const customServiceName = document.getElementById('customServiceName').value.trim();
        if (!customServiceName) {
          notifications.warning("Nazwa usługi jest wymagana", "Brakujące dane");
          return; // Przerwij funkcję jeśli nazwa jest pusta
        }

        // 2. Dopiero teraz pobieraj pozostałe dane
        const customServiceDescription = document.getElementById('customServiceDescription').value.trim();
        const customServicePriceInput = document.getElementById('customServicePrice');
        
        if (!customServicePriceInput) {
          console.error("Nie znaleziono elementu customServicePrice");
          notifications.error("Wystąpił błąd systemowy", "Błąd formularza");
          return;
        }
        
        const customServicePrice = parseFloat(customServicePriceInput.value);
        
        if (isNaN(customServicePrice)) {
          notifications.warning("Cena usługi musi być liczbą", "Niepoprawna wartość");
          return;
        }
        
        // 3. Sprawdź podstawowe dane
        const serwis = document.getElementById('service').value;
        const category = document.getElementById('repairCategory').value;
        const operator = document.getElementById('operator').value;
        const department = document.getElementById('department').value;
        
        if (!serwis || !category || !operator || !department) {
          notifications.warning("Uzupełnij wszystkie dane podstawowe", "Brakujące dane");
          return;
        }
        
        // 4. Tworzenie nowej usługi niestandardowej
        const customId = 'CUSTOM-' + Math.floor(Math.random() * 100000);
        const newItem = {
          code: customId,
          name: customServiceName,
          description: customServiceDescription,
          category: category,
          price: !isNaN(customServicePrice) && customServicePrice >= 0 ? customServicePrice : 0,
          quantity: 1,
          operator: operator,
          department: department,
          serwis: serwis,
          isCustom: true
        };
        
        console.log("Dodawanie niestandardowej usługi do zamówienia:", newItem);
        
        // 5. Ukryj modal przed jakimkolwiek modyfikowaniem danych
        if (modals && modals.customService) {
          modals.customService.hide();
        }
        
        // 6. Dodaj usługę do listy z opóźnieniem po zamknięciu modalu
        setTimeout(() => {
          serviceItems.push(newItem);
          notifications.success(`Dodano niestandardową usługę: ${newItem.name}`, "Dodano do zamówienia");
          updateServiceTable();
          document.getElementById('submitOrderBtn').disabled = false;
        }, 300);
        
      } catch (e) {
        console.error("Błąd podczas dodawania niestandardowej usługi:", e);
        notifications.error(`Wystąpił błąd: ${e.message}`, "Błąd");
      }
    }

    // Funkcja aktualizująca tabelę usług
    function updateServiceTable() {
      const tbody = document.getElementById('serviceItems');
      if (!tbody) return;
      
      if (serviceItems.length === 0) {
        tbody.innerHTML = '<tr id="noServiceItemsRow"><td colspan="5" class="text-center">Brak dodanych usług</td></tr>';
        updateServiceTotal();
        return;
      }
      
      tbody.innerHTML = '';
      
      serviceItems.forEach((item, index) => {
        const row = document.createElement('tr');
        
        // Dodaj indykator dla niestandardowych usług "Inne"
        const nameDisplay = item.isCustom ? 
          `${item.name} <span class="badge bg-success">Niestandardowa</span>` : 
          item.name;
        
        // Dodaj opis dla niestandardowych usług, jeśli istnieje
        const descriptionRow = item.isCustom && item.description ? 
          `<small class="text-muted d-block">${item.description}</small>` : 
          '';
        
        row.innerHTML = `
          <td>${item.code}</td>
          <td>${nameDisplay}${descriptionRow}</td>
          <td>${item.category}</td>
          <td>${item.price.toFixed(2)} zł</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="removeServiceItem(${index})">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      updateServiceTotal();
    }
    
    // Funkcja aktualizująca sumę usług
    function updateServiceTotal() {
      const totalElement = document.getElementById('serviceTotal');
      const totalQuantityElement = document.getElementById('serviceTotalQuantity');
      
      if (!totalElement || !totalQuantityElement) return;
      
      // Obliczanie sumy ilości i cen usług
      const totalQuantity = serviceItems.length;
      const totalPrice = serviceItems.reduce((sum, item) => sum + item.price, 0);
      
      // Aktualizacja elementów HTML
      totalQuantityElement.innerText = totalQuantity;
      totalElement.innerText = totalPrice.toFixed(2) + ' zł';
    }
      // Funkcja do usuwania usługi z tabeli
    function removeServiceItem(index) {
      if (index >= 0 && index < serviceItems.length) {
        const removedItem = serviceItems[index];
        serviceItems.splice(index, 1);
        updateServiceTable();
        notifications.info(`Usunięto usługę: ${removedItem.name}`);
        
        // Sprawdź, czy na liście pozostała usługa "Serwis podstawowy"
        const hasSerwisBasic = serviceItems.some(item => item.name === 'Serwis podstawowy');
        
        // Wyłącz przycisk wysyłki tylko jeśli nie ma usług, części i nie ma "Serwis podstawowy"
        if (serviceItems.length === 0 && orderItems.length === 0 && !hasSerwisBasic) {
          document.getElementById('submitOrderBtn').disabled = true;
        }
      }
    }

    // Funkcja do ładowania i wyświetlania kategorii produktów jako kafelki w modalu
    function loadProductCategories() {
      try {
        if (!cennikId) {
          notifications.warning("Najpierw wybierz wszystkie dane podstawowe", "Nie można załadować kategorii");
          return;
        }

        const category = document.getElementById('repairCategory').value;
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success && Array.isArray(result.categories)) {
              displayProductCategories(result.categories);
              console.log("Załadowano kategorie produktów:", result.categories);
            } else {
              console.error("Brak kategorii produktów lub błąd:", result);
              notifications.warning("Nie można załadować kategorii produktów", "Brak danych");
            }
          })
          .withFailureHandler(function(error) {
            console.error("Błąd podczas pobierania kategorii produktów:", error);
            notifications.error("Wystąpił błąd podczas pobierania kategorii produktów");
          })
          .getProductCategories(cennikId, category);
      } catch (e) {
        console.error("Błąd w loadProductCategories:", e);
      }
    }

    // Funkcja wyświetlająca kategorie produktów jako kafelki w modalu
    function displayProductCategories(categories) {
      try {
        // Używamy kontenera kategorii w modalu
        const categoriesContainer = document.getElementById('categoryTilesContainer');
        const tilesWrapper = document.getElementById('categoryTilesWrapper');
        
        if (!categoriesContainer || !tilesWrapper) {
          console.error("Nie znaleziono kontenerów dla kafelków kategorii");
          return;
        }
        
        categoriesContainer.classList.remove('hidden');
        tilesWrapper.innerHTML = '';
        
        // Dodaj kafelek "Wszystkie kategorie"
        const allCategoryTile = document.createElement('div');
        allCategoryTile.className = 'category-tile category-tile-active';
        allCategoryTile.innerHTML = 'Wszystkie';
        allCategoryTile.dataset.category = '';
        allCategoryTile.addEventListener('click', function() {
          selectProductCategory('');
        });
        tilesWrapper.appendChild(allCategoryTile);
        
        // Dodaj kafelki dla każdej kategorii
        categories.forEach(function(category) {
          if (!category) return; // Pomijaj puste kategorie
          
          const tile = document.createElement('div');
          tile.className = 'category-tile';
          tile.innerHTML = category; // Usunięto ikony, aby kafelki zajmowały mniej miejsca
          tile.dataset.category = category;
          tile.addEventListener('click', function() {
            selectProductCategory(category);
          });
          tilesWrapper.appendChild(tile);
        });
        
        console.log(`Wyrenderowano ${categories.length + 1} kafelków kategorii produktów`);
      } catch (e) {
        console.error("Błąd w displayProductCategories:", e);
      }
    }

    // Funkcja do wybierania kategorii produktu
    function selectProductCategory(category) {
      try {
        console.log("Wybrano kategorię produktu:", category);
        
        // Usunięcie klasy active ze wszystkich kafelków
        const tiles = document.querySelectorAll('.category-tile');
        tiles.forEach(function(tile) {
          tile.classList.remove('category-tile-active');
        });
        
        // Dodanie klasy active do wybranego kafelka
        const selectedTile = document.querySelector(`.category-tile[data-category="${category}"]`);
        if (selectedTile) {
          selectedTile.classList.add('category-tile-active');
        }
        
        // Filtrowanie produktów
        if (!category) {
          // Pokaż wszystkie produkty
          resetProductsFilter();
          notifications.info("Wyświetlono wszystkie produkty", "Filtrowanie");
        } else {
          // Filtruj produkty według wybranej kategorii
          filterProductsByCategory(category);
          notifications.info(`Wyświetlono produkty z kategorii: ${category}`, "Filtrowanie");
        }
      } catch (e) {
        console.error("Błąd w selectProductCategory:", e);
        notifications.error("Wystąpił błąd podczas filtrowania produktów");
      }
    }

    // Funkcja filtrująca produkty według kategorii
    function filterProductsByCategory(category) {
      if (!category || !allLoadedProducts || allLoadedProducts.length === 0) return;
      
      console.log("Filtrowanie produktów według kategorii:", category);
      
      const filteredProducts = allLoadedProducts.filter(product => {
        return product['Kategoria produktu'] === category;
      });
      
      console.log(`Znaleziono ${filteredProducts.length} produktów w kategorii "${category}"`);
      
      const resultsContainer = document.getElementById('productSearchResults');
      const noResults = document.getElementById('productSearchNoResults');
      
      if (filteredProducts.length > 0) {
        displayProductSearchResults(filteredProducts);
        if (noResults) noResults.classList.add('d-none');
      } else {
        if (resultsContainer) resultsContainer.innerHTML = '';
        if (noResults) {
          noResults.innerText = `Nie znaleziono produktów w kategorii "${category}"`;
          noResults.classList.remove('d-none');
        }
      }
    }    // Funkcja wyświetlająca komunikat postępu
    function showProgressMessage(message) {
      // Sprawdź czy div z komunikatem postępu już istnieje, jeśli nie - utwórz go
      let progressDiv = document.getElementById('progressMessageDiv');
      
      if (!progressDiv) {
        progressDiv = document.createElement('div');
        progressDiv.id = 'progressMessageDiv';
        progressDiv.style.position = 'fixed';
        progressDiv.style.top = '50%';
        progressDiv.style.left = '50%';
        progressDiv.style.transform = 'translate(-50%, -50%)';
        progressDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        progressDiv.style.color = 'white';
        progressDiv.style.padding = '20px';
        progressDiv.style.borderRadius = '10px';
        progressDiv.style.zIndex = '9999';
        progressDiv.style.textAlign = 'center';
        progressDiv.style.minWidth = '300px';
        document.body.appendChild(progressDiv);
      }
      
      // Utwórz zawartość komunikatu z animacją
      progressDiv.innerHTML = `
        <div class="loader" style="margin: 0 auto 15px auto;"></div>
        <div style="font-size: 18px; font-weight: bold;">${message}</div>
      `;
      
      // Pokaż div
      progressDiv.style.display = 'block';
    }
    
    // Funkcja ukrywająca komunikat postępu
    function hideProgressMessage() {
      const progressDiv = document.getElementById('progressMessageDiv');
      if (progressDiv) {
        progressDiv.style.display = 'none';
      }
    }

    // Funkcja obsługująca zapisywanie raportu serwisowego
    function submitOrder() {
      try {
        console.log("Rozpoczęcie zapisywania raportu serwisowego...");
        
        // Pokaż komunikat postępu
        showProgressMessage("Trwa zapisywanie raportu...");
        
        // Sprawdzenie czy wymagane pola są wypełnione
        const serwis = document.getElementById('service').value;
        const category = document.getElementById('repairCategory').value;
        const operator = document.getElementById('operator').value;
        const department = document.getElementById('department').value;
        
        // Pobranie wartości ramki
        const frameNumberSelect = document.getElementById('frameNumberSelect');
        let frameValue = frameNumberSelect ? frameNumberSelect.value : '';
          // Pobranie pozostałych wymaganych danych
        const serviceDate = document.getElementById('serviceDate').value;
        const dateOnly = serviceDate.split('T')[0];
        const bikeMileage = document.getElementById('bikeMileage').value;
        let laborHours = document.getElementById('laborHours').value;
        if (laborHours && laborHours.includes('.')) {
          laborHours = laborHours.replace('.', ',');
        }
        const isOnSite = document.getElementById('isOnSite').value;
        const serviceConfirmationEmail = document.getElementById('serviceConfirmationEmail').value;
        
    // Sprawdzenie wszystkich wymaganych pól
        let missingFields = [];        if (!serwis) missingFields.push("Rodzaj serwisu");
        if (!frameValue) missingFields.push("Numer ramy");
        if (!serviceDate) missingFields.push("Data serwisu");
        if (!bikeMileage) missingFields.push("Przebieg (km)");
        if (!serviceConfirmationEmail) missingFields.push("Email do potwierdzenia serwisu");
        // Pole laborHours jest opcjonalne, więc nie sprawdzamy go
        if (!isOnSite) missingFields.push("Dojazd");
        
        // Sprawdzenie czy email ma prawidłowy format
        if (serviceConfirmationEmail && !isValidEmail(serviceConfirmationEmail)) {
          notifications.error("Wprowadź prawidłowy adres email dla potwierdzenia serwisu", "Nieprawidłowy email");
          return;
        }
        
        // Jeśli brakuje jakichkolwiek wymaganych pól, pokaż błąd i przerwij
        if (missingFields.length > 0) {
          notifications.error(`Uzupełnij wszystkie wymagane pola oznaczone czerwoną gwiazdką: ${missingFields.join(", ")}`, "Brakujące dane");
          return;
        }
        
        // Uwaga: Części nie są już wymagane do zapisania raportu
        
        // Sprawdzenie czy wybrano typ serwisu
        const serviceTypeBasic = document.getElementById('serviceTypeBasic');
        const serviceTypeAdvanced = document.getElementById('serviceTypeAdvanced');
        
        if (!serviceTypeBasic.checked && !serviceTypeAdvanced.checked) {
          notifications.warning("Wybierz typ serwisu", "Brakujące dane");
          return;
        }
        
        let bikeSerialNumber = '';
        let bikeModel = '';
        
        if (frameValue) {
          try {
            const frameData = JSON.parse(frameValue);
            bikeSerialNumber = frameData.serialNumber || '';
            bikeModel = frameData.model || '';
          } catch (e) {
            console.warn("Błąd parsowania danych ramki:", e);
          }
        }
        
        // Get service type
        let serviceType = serviceTypeBasic.checked ? 'Podstawowy' : 'Eksploatacyjny';
        
        // Get notes
        let notes = document.getElementById('orderNotes').value;
        
        // Przygotowanie danych raportu
        const reportData = {
          serwis: serwis,
          category: category,
          operator: operator,
          department: department,
          address: getAddressDataForClient(serwis),
          serviceType: serviceType,
          serviceDate: dateOnly,
          bikeModel: bikeModel,
          bikeSerialNumber: bikeSerialNumber,          bikeMileage: bikeMileage,
          laborHours: laborHours,
          isOnSite: isOnSite,
          notes: notes,
          serviceConfirmationEmail: serviceConfirmationEmail,
          
          // Bardzo ważne: Przekaz tablice usług i części do serwera
          services: serviceItems, // Przekazanie usług do zapisania
          parts: orderItems // Przekazanie części do zapisania
        };
        
        // Sprawdź czy są zdjęcia do przesłania
        const hasBeforeImages = beforeImages.length > 0;
        const hasAfterImages = afterImages.length > 0;
        
        console.log(`Przygotowane dane raportu z ${beforeImages.length} zdjęciami przed naprawą i ${afterImages.length} zdjęciami po naprawie`);
        
        // Jeśli są zdjęcia, ustaw wartości pól z linkami dla kompatybilności wstecznej
        if (hasBeforeImages || hasAfterImages) {
          document.getElementById('beforeImagesLink').value = hasBeforeImages ? 'Zdjęcia będą zapisane po wysłaniu formularza' : '';
          document.getElementById('afterImagesLink').value = hasAfterImages ? 'Zdjęcia będą zapisane po wysłaniu formularza' : '';
          
          // Dodaj informację o oczekujących zdjęciach
          reportData.hasPendingImages = true;
        }
        
        // Wysłanie danych do serwera
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // Pobierz reportId z wyniku
              const reportId = result.reportId;
              console.log("Raport zapisany pomyślnie, ID:", reportId);
                // Jeśli są zdjęcia do przesłania, najpierw je prześlij
              if (hasBeforeImages || hasAfterImages) {
                uploadImages(reportId);
              } else {
                // Jeśli nie ma zdjęć, od razu pokaż podsumowanie
                handleReportSaved(result);
              }              setFormDisabled(true); // Pozostaw zablokowane do zamknięcia modalu
              // Nie ukrywamy komunikatu postępu - zostanie ukryty po zakończeniu całego procesu
            } else {
              setFormDisabled(false);
              document.getElementById('submitOrderBtn').disabled = false;
              hideProgressMessage();
              handleReportError(result);
            }
          })
          .withFailureHandler(function(error) {
            hideProgressMessage();
            setFormDisabled(false);
            document.getElementById('submitOrderBtn').disabled = false;
            handleReportError(error);
          })
          .saveReport(reportData);      } catch (e) {
        hideProgressMessage();
        setFormDisabled(false);
        document.getElementById('submitOrderBtn').disabled = false;
        notifications.error("Wystąpił nieoczekiwany błąd: " + e.message, "Błąd krytyczny");
        console.error("Błąd krytyczny w submitOrder:", e);
      }
    }
    
    // Funkcja blokująca/odblokowująca wszystkie pola formularza
    function setFormDisabled(disabled) {
      const formElements = document.querySelectorAll('input, select, textarea, button');
      formElements.forEach(el => {
        if (el.id !== 'completeOrderBtn' && el.id !== 'newReportBtn') {
          el.disabled = disabled;
        }
      });
    }    // Funkcja obsługująca błędy podczas zapisywania raportu
    function handleReportError(error) {
      hideProgressMessage();
      document.getElementById('submitOrderBtn').disabled = false;
      notifications.error("Wystąpił błąd podczas zapisywania raportu: " + (error.message || "Nieznany błąd"), "Błąd zapisu");
      console.error("Błąd zapisywania raportu:", error);
    }    // Funkcja obsługująca sukces zapisania raportu
    function handleReportSaved(result) {
      // Nie ukrywamy komunikatu postępu tutaj - zostanie ukryty po całym procesie
      document.getElementById('submitOrderBtn').disabled = false;
      if (result.success) {
        // Wyświetl informację o sukcesie wraz z numerem raportu
        const reportId = result.reportId || "niezdefiniowany";
        
        // Przygotowanie danych do wyświetlania w przyszłości
        if (result.reportData) {
          localStorage.setItem('lastReportData', JSON.stringify(result.reportData));
        }
        
        // Przesłanie zdjęć do serwera
        if (beforeImages.length > 0 || afterImages.length > 0) {
          uploadImages(reportId);
        } else {
          // Wyświetl podsumowanie końcowe z nowym modalem tylko jeśli nie ma zdjęć do przesłania
          // W przeciwnym razie zostanie wyświetlone przez funkcję uploadImages po zakończeniu przesyłania
          showFinalSummary(reportId);
        }
      } else {
        notifications.error("Błąd zapisywania raportu: " + (result.message || "Nieznany błąd"), "Błąd zapisu");
      }
    }    // Funkcja przesyłająca zdjęcia do serwera
    function uploadImages(reportId) {      // Pokaż komunikat postępu zamiast prostego loadera
      showProgressMessage("Trwa przesyłanie zdjęć...");
      // Pobranie nazwy serwisu
      const serwisElement = document.getElementById('service');
      const serwisName = serwisElement ? (serwisElement.options[serwisElement.selectedIndex]?.text || "Serwis") : "Serwis";
        // Przygotowanie zdjęć do wysyłania
      const allImages = [];
        // Dodanie zdjęć przed naprawą
      beforeImages.forEach((image, index) => {
        const today = new Date();
        const dateStr = today.toLocaleDateString('pl-PL', {day: '2-digit', month: '2-digit', year: 'numeric'}).replace(/\./g, '-');
        
        // Pobierz pełną tekstową wartość wybranego elementu, która zawiera numer ramy
        let frameNumber = '';
        const frameSelect = document.getElementById('frameNumberSelect');
        if (frameSelect && frameSelect.selectedOptions && frameSelect.selectedOptions.length > 0) {
          // Pobierz pełny tekst wybranej opcji (może zawierać numer ramy i dodatkowe informacje)
          const fullText = frameSelect.selectedOptions[0].textContent || '';
          // Wyciągnij sam numer ramy (wszystko przed pierwszym białym znakiem)
          frameNumber = fullText.split(' ')[0] || '';
          console.log("Pobrano numer ramy:", frameNumber);
        }        const imageName = `[${reportId}] - [${frameNumber}] - [${serwisName}] - ${dateStr} - before ${index + 1}`;
        
        allImages.push({
          data: image.data,
          name: imageName,
          type: 'before',
          size: image.size,
          frameNumber: frameNumber, // Dodanie osobnego pola z numerem ramy
          serwisName: serwisName // Dodanie osobnego pola z nazwą serwisu
        });
      });
      
      // Dodanie zdjęć po naprawie
      afterImages.forEach((image, index) => {
        const today = new Date();
        const dateStr = today.toLocaleDateString('pl-PL', {day: '2-digit', month: '2-digit', year: 'numeric'}).replace(/\./g, '-');
        
        // Pobierz pełną tekstową wartość wybranego elementu, która zawiera numer ramy
        let frameNumber = '';
        const frameSelect = document.getElementById('frameNumberSelect');
        if (frameSelect && frameSelect.selectedOptions && frameSelect.selectedOptions.length > 0) {
          // Pobierz pełny tekst wybranej opcji (może zawierać numer ramy i dodatkowe informacje)
          const fullText = frameSelect.selectedOptions[0].textContent || '';
          // Wyciągnij sam numer ramy (wszystko przed pierwszym białym znakiem)
          frameNumber = fullText.split(' ')[0] || '';
        }        const imageName = `[${reportId}] - [${frameNumber}] - [${serwisName}] - ${dateStr} - after ${index + 1}`;
        
        allImages.push({
          data: image.data,
          name: imageName,
          type: 'after',
          size: image.size,
          frameNumber: frameNumber, // Dodanie osobnego pola z numerem ramy
          serwisName: serwisName // Dodanie osobnego pola z nazwą serwisu
        });
      });
        if (allImages.length === 0) {
        // Jeśli jednak nie ma zdjęć do wysłania, zakończ proces
        notifications.warning("Nie znaleziono zdjęć do przesyłania", "Brak zdjęć");
        hideProgressMessage();
        // Pokaż podsumowanie końcowe, nawet jeśli nie było zdjęć do przesłania
        showFinalSummary(reportId);
        return;
      }
      
      // Przygotowanie danych do wysłania do serwera
      const imagesData = {
        reportId: reportId,
        images: allImages
      };
        // Wysłanie zdjęć do serwera
      google.script.run
        .withSuccessHandler(function(result) {
          hideProgressMessage(); // Ukryj komunikat postępu po zakończeniu przesyłania
          if (result.success) {
            notifications.success(`Przesłano ${allImages.length} zdjęć do raportu ${reportId}`, "Zdjęcia zapisane");
            // Pokaż podsumowanie końcowe po pomyślnym przesłaniu zdjęć
            showFinalSummary(reportId);
          } else {
            notifications.error("Błąd podczas przesyłania zdjęć: " + (result.message || "Nieznany błąd"), "Błąd");
            // Pokaż podsumowanie końcowe nawet w przypadku błędu z przesyłaniem zdjęć
            showFinalSummary(reportId);
          }
        })        .withFailureHandler(function(error) {
          hideProgressMessage();
          notifications.error("Błąd podczas przesyłania zdjęć: " + (error.message || "Nieznany błąd"), "Błąd");
          // Pokaż podsumowanie końcowe nawet w przypadku błędu
          showFinalSummary(reportId);
        })
        .saveServiceImages(reportId, imagesData);
    }

    // Funkcje do dynamicznego dostosowania wysokości iframe
    function setIframeHeight() {
      try {
        if (window !== window.parent) {
          const currentHeight = Math.max(
            document.body.scrollHeight,
            document.documentElement.scrollHeight,
            document.body.offsetHeight,
            document.documentElement.offsetHeight,
            document.body.clientHeight,
            document.documentElement.clientHeight
          );

          // Dodaj małą marżę na wszelki wypadek
          const heightWithMargin = currentHeight + 50;

          // Poinformuj rodzica o nowej wysokości
          window.parent.postMessage({
            height: heightWithMargin,
            width: '100%',
            isMobile: window.innerWidth <= 768 // Dodaj informację czy to urządzenie mobilne
          }, '*');

          console.log("Wysłano żądanie dopasowania rozmiaru iframe:", heightWithMargin, "szerokość:", window.innerWidth);
          
          // Dostosowanie szerokości dla urządzeń mobilnych
          if (window.innerWidth <= 768) {
            document.documentElement.style.setProperty('--container-max-width', '100%');
            document.body.classList.add('mobile-view');
            
            // Poprawka dla tabeli na urządzeniach mobilnych
            const tables = document.querySelectorAll('.order-table');
            tables.forEach(table => {
              table.classList.add('table-responsive');
            });
          } else {
            document.body.classList.remove('mobile-view');
          }
        } else {
          console.log("Aplikacja nie działa w iframe, pomijanie dopasowania wysokości");
        }
      } catch (e) {
        console.warn("Błąd podczas próby dostosowania iframe:", e);
      }
    }

    // Nasłuchiwanie wiadomości od rodzica iframe
    window.addEventListener('message', function(event) {
      try {
        const message = event.data;
        if (message.viewportWidth) {
          console.log("Otrzymano szerokość ekranu od rodzica:", message.viewportWidth);
          document.documentElement.style.setProperty('--viewport-width', message.viewportWidth + 'px');
        }
      } catch (e) {
        console.warn("Błąd podczas przetwarzania wiadomości z iframe:", e);
      }
    });

    // Wywołanie funkcji przy załadowaniu i przy zmianie rozmiaru okna
    window.addEventListener('DOMContentLoaded', setIframeHeight);
    window.addEventListener('resize', setIframeHeight);
    window.addEventListener('load', setIframeHeight);

    // Obserwator zmian w DOM
    const observer = new MutationObserver(function() {
      setIframeHeight();
    });
    observer.observe(document.body, { childList: true, subtree: true });

    // Funkcja do inicjalizacji panelu zdjęć - poprawiona wersja z obsługą drag and drop
    function initImageUpload() {
      // Obsługa strefy zrzutu dla zdjęć przed naprawą
      setupDragAndDrop('beforeImageUpload', 'beforeImagesInput', 'before');
      
      // Obsługa strefy zrzutu dla zdjęć po naprawie
      setupDragAndDrop('afterImageUpload', 'afterImagesInput', 'after');
      
      console.log("Inicjalizacja obsługi drag and drop dla zdjęć zakończona");
    }
    
    // Funkcja konfigurująca obszar drag and drop dla zdjęć
    function setupDragAndDrop(dropAreaId, inputId, imageType) {
      const dropArea = document.getElementById(dropAreaId);
      const inputElement = document.getElementById(inputId);
      
      if (!dropArea || !inputElement) {
        console.error(`Nie znaleziono elementów dla ${dropAreaId} lub ${inputId}`);
        return;
      }
      
      // Zapobieganie domyślnym zachowaniom przeglądarki
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });
      
      // Funkcja zapobiegająca domyślnym zachowaniom
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      // Podświetlanie obszaru podczas przeciągania
      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => {
          dropArea.classList.add('drag-over');
        }, false);
      });
      
      // Usunięcie podświetlenia, gdy opuszczamy obszar lub upuszczamy plik
      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => {
          dropArea.classList.remove('drag-over');
        }, false);
      });
      
      // Obsługa upuszczenia plików
      dropArea.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          inputElement.files = files;
          handleImageUpload({ target: inputElement }, imageType);
        }
      }, false);
      
      console.log(`Skonfigurowano obsługę drag and drop dla ${dropAreaId}`);
    }

    // Funkcja obsługująca przesłane zdjęcia - poprawiona wersja
    function handleImageUpload(event, type) {
      try {
        const files = event.target.files;
        if (!files || files.length === 0) {
          console.warn("Nie wybrano żadnych plików");
          return;
        }
        
        console.log(`Wybrano ${files.length} zdjęć typu ${type}`);
        
        // Określenie, których tablic i elementów użyć na podstawie typu
        const imagesArray = type === 'before' ? beforeImages : afterImages;
        const previewContainer = document.getElementById(type + 'ImagesPreview');
        const countDisplay = document.getElementById(type + 'ImageCount');
        
        if (!previewContainer || !countDisplay) {
          console.error(`Nie znaleziono elementów do wyświetlania podglądu dla typu ${type}`);
          return;
        }
        
        // Dla każdego wybranego pliku
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          
          // Sprawdzenie czy to obraz
          if (!file.type.match('image.*')) {
            notifications.warning(`Plik ${file.name} nie jest obrazem. Tylko pliki obrazów są akceptowane.`);
            continue;
          }
          
          // Ograniczenie rozmiaru pliku (10MB)
          if (file.size > 10 * 1024 * 1024) {
            notifications.warning(`Plik ${file.name} jest zbyt duży. Maksymalny rozmiar to 10MB.`);
            continue;
          }
          
          const reader = new FileReader();
          
          reader.onload = function(e) {
            // Tworzenie obiektu obrazu do zapisania w tablicy
            const imageObj = {
              name: file.name,
              type: type,
              size: file.size,
              data: e.target.result
            };
            
            // Dodaj do odpowiedniej tablicy
            imagesArray.push(imageObj);
            
            // Aktualizuj podgląd
            updateImagesPreview(imagesArray, previewContainer, countDisplay);
          };
          
          reader.readAsDataURL(file);
        }
      } catch (e) {
        console.error("Błąd podczas obsługi przesłanych zdjęć:", e);
        notifications.error("Wystąpił błąd podczas przesyłania zdjęć");
      }
    }

    // Funkcja aktualizująca podgląd zdjęć
    function updateImagesPreview(imagesArray, previewContainer, countDisplay) {
      try {
        if (!imagesArray || !previewContainer || !countDisplay) {
          console.error("Nie znaleziono elementów do aktualizacji podglądu zdjęć");
          return;
        }
        
        previewContainer.innerHTML = '';
        
        imagesArray.forEach((image, index) => {
          const previewItem = document.createElement('div');
          previewItem.className = 'image-preview-item';
          
          previewItem.innerHTML = `
            <img src="${image.data}" alt="${image.name}" title="${image.name}">
            <button class="remove-image" onclick="removeImage('${image.type}', ${index})">&times;</button>
            <div class="image-type">${image.type}</div>
          `;
          
          previewContainer.appendChild(previewItem);
        });
        
        countDisplay.innerText = imagesArray.length;
        previewContainer.style.display = imagesArray.length > 0 ? 'flex' : 'none';
      } catch (e) {
        console.error("Błąd podczas aktualizacji podglądu zdjęć:", e);
        notifications.error("Wystąpił błąd podczas aktualizacji podglądu zdjęć");
      }
    }

    // Funkcja usuwająca zdjęcie z tablicy
    function removeImage(type, index) {
      try {
        const imagesArray = type === 'before' ? beforeImages : afterImages;
        const previewContainer = document.getElementById(type + 'ImagesPreview');
        const countDisplay = document.getElementById(type + 'ImageCount');
        
        if (!imagesArray || !previewContainer || !countDisplay) {
          console.error("Nie znaleziono elementów do usunięcia zdjęcia");
          return;
        }
        
        imagesArray.splice(index, 1);
        updateImagesPreview(imagesArray, previewContainer, countDisplay);
        notifications.info(`Usunięto zdjęcie typu ${type}`);
      } catch (e) {
        console.error("Błąd podczas usuwania zdjęcia:", e);
        notifications.error("Wystąpił błąd podczas usuwania zdjęcia");
      }
    }

    // Funkcja do pobierania danych adresowych dla klienta
    function getAddressDataForClient(serwis) {
      // Uproszczona implementacja - zwraca pusty obiekt adresu
      // Możesz dostosować tę funkcję do swoich potrzeb
      return {
        street: "",
        city: "",
        postalCode: "",
        country: "Polska"
      };
    }
    
    // Funkcja do wyświetlenia podsumowania końcowego
    function showFinalSummary(reportId) {
      console.log("Wyświetlanie podsumowania końcowego dla reportId:", reportId);
      try {
        // Ukryj komunikat postępu jeśli jeszcze jest wyświetlany
        hideProgressMessage();
        
        // Ustawienie numeru ID raportu
        const reportIdDisplay = document.getElementById('reportIdDisplay');
        if (reportIdDisplay) {
          reportIdDisplay.textContent = reportId;
        } else {
          console.error("Nie znaleziono elementu reportIdDisplay");
        }
        
        // Pobranie referencji do modalu
        const finalSummaryModalElement = document.getElementById('finalSummaryModal');
        if (!finalSummaryModalElement) {
          console.error("Nie znaleziono elementu finalSummaryModal w DOM");
          return;
        }
        
        // Sprawdź czy modal jest już zainicjalizowany
        let finalSummaryModal;
        if (modals && modals.finalSummary) {
          console.log("Używanie istniejącej instancji modalu finalSummary");
          finalSummaryModal = modals.finalSummary;
        } else {
          console.log("Tworzenie nowej instancji modalu finalSummary");
          finalSummaryModal = new bootstrap.Modal(finalSummaryModalElement);
          if (modals) {
            modals.finalSummary = finalSummaryModal;
          }
        }
        
        // Obsługa przycisku "Zamknij" - bezpośrednie ustawienie funkcji onclick
        const closeBtn = document.getElementById('closeFinalSummaryBtn');
        if (closeBtn) {
          // Usuwamy wszystkie istniejące handlary zdarzenia click
          const clonedBtn = closeBtn.cloneNode(true);
          closeBtn.parentNode.replaceChild(clonedBtn, closeBtn);
          
          // Ustawienie funkcji onclick bezpośrednio w atrybucie HTML
          clonedBtn.setAttribute('onclick', "window.location.href='https://cargobikeserwis.com/dpd/'");
          
          // Dodatkowa funkcja click dla pewności
          clonedBtn.addEventListener('click', function(e) {
            e.preventDefault(); // Zapobiegamy domyślnej akcji
            e.stopPropagation(); // Zatrzymujemy propagację zdarzenia
            console.log("Wykonuję przekierowanie z event listenera...");
            window.location.href = 'https://cargobikeserwis.com/dpd/';
          });
          
          console.log("Przypisano akcję przekierowania do przycisku Zamknij");
        } else {
          console.error("Nie znaleziono przycisku zamykania");
        }
        
        // Wyświetlenie modalu
        finalSummaryModal.show();
      } catch (e) {
        console.error("Błąd podczas wyświetlania podsumowania końcowego:", e);
        notifications.error("Wystąpił błąd podczas wyświetlania podsumowania", "Błąd krytyczny");
      }
    }
  </script>
</body>
</html>